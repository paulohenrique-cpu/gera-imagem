<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoShop Pro - Editor Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .photoshop-interface {
            background: #2c2c2c;
            color: #cccccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        .toolbar {
            background: #3c3c3c;
            border-right: 1px solid #555;
            width: 60px;
        }
        
        .tool-button {
            width: 50px;
            height: 50px;
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .tool-button:hover {
            background: #4a4a4a;
        }
        
        .tool-button.active {
            background: #0078d4;
        }
        
        .menu-bar {
            background: #2c2c2c;
            border-bottom: 1px solid #555;
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        
        .menu-item {
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .menu-item:hover {
            background: #4a4a4a;
        }
        
        .canvas-area {
            background: #2c2c2c;
            position: relative;
            overflow: hidden;
        }
        
        .canvas-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid #555;
            background: white;
        }
        
        .layers-panel {
            background: #3c3c3c;
            border-left: 1px solid #555;
            width: 280px;
        }
        
        .panel-header {
            background: #2c2c2c;
            padding: 8px 12px;
            border-bottom: 1px solid #555;
            font-weight: bold;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .layer-item {
            background: #3c3c3c;
            border-bottom: 1px solid #555;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            min-height: 48px;
            position: relative;
            z-index: 1;
        }
        
        .layer-item:hover {
            background: #4a4a4a;
        }
        
        .layer-item.active {
            background: #0078d4;
        }
        
        .layer-item button {
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .layer-item:hover button {
            opacity: 1;
        }
        
        .layer-thumbnail {
            width: 32px;
            height: 32px;
            background: #555;
            border: 1px solid #666;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .properties-panel {
            background: #3c3c3c;
            border-top: 1px solid #555;
            padding: 12px;
        }
        
        .slider-control {
            margin-bottom: 12px;
        }
        
        .slider-control label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .slider-control input[type="range"] {
            width: 100%;
            height: 4px;
            background: #555;
            border-radius: 2px;
            outline: none;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .filter-button {
            background: #4a4a4a;
            border: 1px solid #666;
            color: #cccccc;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .filter-button:hover {
            background: #5a5a5a;
            border-color: #0078d4;
        }
        
        .status-bar {
            background: #2c2c2c;
            border-top: 1px solid #555;
            height: 25px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 11px;
            gap: 20px;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid #666;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .brush-preview {
            width: 40px;
            height: 40px;
            border: 1px solid #666;
            border-radius: 50%;
            background: radial-gradient(circle, #cccccc 0%, transparent 70%);
            margin: 8px auto;
        }
        
        .history-item {
            padding: 4px 12px;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 1px solid #555;
        }
        
        .history-item:hover {
            background: #4a4a4a;
        }
        
        .dropdown-menu {
            position: absolute;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 150px;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #555;
        }
        
        .dropdown-item:hover {
            background: #4a4a4a;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .tool-group:hover .tool-submenu {
            display: block;
        }
        
        .tool-submenu {
            min-width: 200px;
            z-index: 1001;
        }
        
        .tool-sub-button {
            width: 100%;
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            text-align: left;
            transition: background 0.2s;
        }
        
        .tool-sub-button:hover {
            background: #4a4a4a;
        }
        
        .tool-group {
            position: relative;
        }
        
        .tool-group::after {
            content: 'â–¶';
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            color: #888;
            pointer-events: none;
        }
        
        .tool-group:first-child::after {
            display: none;
        }
    </style>
</head>
<body class="photoshop-interface h-screen overflow-hidden">
    <!-- Logo Bar -->
    <div class="bg-gray-900 border-b border-gray-600 p-2 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <img src="https://ik.imagekit.io/ys8l6suo53/lojo%201.png?updatedAt=" alt="Logo" class="h-8 w-auto">
            <span class="text-white font-bold text-lg">PhotoShop Pro</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="showCanvasSizeDialog()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-white text-sm flex items-center gap-2">
                ğŸ“ Tamanho da Tela
            </button>
            <button onclick="addTextToCanvas()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white text-sm flex items-center gap-2">
                ğŸ“ Adicionar Texto
            </button>
            <button onclick="showBackgroundsPanel()" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-white text-sm flex items-center gap-2">
                ğŸ–¼ï¸ Fundos
            </button>
            <button onclick="showProductsPanel()" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-white text-sm flex items-center gap-2">
                ğŸ“¦ Produtos
            </button>
            <button onclick="showAdjustmentsPanel()" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-white text-sm flex items-center gap-2">
                ğŸ›ï¸ Ajustes
            </button>
            <button onclick="groupSelectedElements()" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded text-white text-sm flex items-center gap-2" id="groupBtn">
                ğŸ“ Agrupar
            </button>
        </div>
    </div>

    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item" onclick="toggleDropdown('fileMenu', event)">File</div>
        <div class="menu-item" onclick="toggleDropdown('editMenu', event)">Edit</div>
        <div class="menu-item" onclick="toggleDropdown('imageMenu', event)">Image</div>
        <div class="menu-item" onclick="toggleDropdown('layerMenu', event)">Layer</div>
        <div class="menu-item" onclick="toggleDropdown('filterMenu', event)">Filter</div>
        <div class="menu-item" onclick="toggleDropdown('viewMenu', event)">View</div>
        <div class="menu-item" onclick="toggleDropdown('windowMenu', event)">Window</div>
        
        <!-- Dropdown Menus -->
        <div id="fileMenu" class="dropdown-menu hidden">
            <div class="dropdown-item" onclick="openFile()">ğŸ“ Open... (Ctrl+O)</div>
            <div class="dropdown-item" onclick="addImage()">ğŸ–¼ï¸ Add Images...</div>
            <div class="dropdown-item" onclick="addTextElement()">ğŸ“ Add Text...</div>
            <div class="dropdown-item" onclick="saveFile()">ğŸ’¾ Save (Ctrl+S)</div>
            <div class="dropdown-item" onclick="exportFile()">ğŸ“¤ Export As...</div>
            <div class="dropdown-item" onclick="newDocument()">ğŸ“„ New... (Ctrl+N)</div>
        </div>
        
        <div id="editMenu" class="dropdown-menu hidden">
            <div class="dropdown-item" onclick="undo()">â†¶ Undo (Ctrl+Z)</div>
            <div class="dropdown-item" onclick="redo()">â†· Redo (Ctrl+Y)</div>
            <div class="dropdown-item" onclick="copy()">ğŸ“‹ Copy (Ctrl+C)</div>
            <div class="dropdown-item" onclick="paste()">ğŸ“„ Paste (Ctrl+V)</div>
            <div class="dropdown-item" onclick="transform()">ğŸ”„ Transform</div>
        </div>
        
        <div id="imageMenu" class="dropdown-menu hidden">
            <div class="dropdown-item" onclick="adjustBrightness()">â˜€ï¸ Brightness/Contrast</div>
            <div class="dropdown-item" onclick="adjustLevels()">ğŸ“Š Levels (Ctrl+L)</div>
            <div class="dropdown-item" onclick="adjustCurves()">ğŸ“ˆ Curves (Ctrl+M)</div>
            <div class="dropdown-item" onclick="adjustHueSat()">ğŸ¨ Hue/Saturation</div>
            <div class="dropdown-item" onclick="removeBackground()">âœ‚ï¸ Remove Background</div>
        </div>
        
        <div id="layerMenu" class="dropdown-menu hidden">
            <div class="dropdown-item" onclick="newLayer()">â• New Layer (Ctrl+Shift+N)</div>
            <div class="dropdown-item" onclick="duplicateLayer()">ğŸ“‘ Duplicate Layer (Ctrl+J)</div>
            <div class="dropdown-item" onclick="deleteLayer()">ğŸ—‘ï¸ Delete Layer</div>
            <div class="dropdown-item" onclick="addMask()">ğŸ­ Add Layer Mask</div>
        </div>
        
        <div id="filterMenu" class="dropdown-menu hidden">
            <div class="dropdown-item" onclick="applyBlur()">ğŸŒ«ï¸ Blur</div>
            <div class="dropdown-item" onclick="applySharpen()">ğŸ” Sharpen</div>
            <div class="dropdown-item" onclick="applyNoise()">ğŸ“º Noise</div>
            <div class="dropdown-item" onclick="applyDistort()">ğŸŒ€ Distort</div>
        </div>
    </div>

    <div class="flex h-full">
        <!-- Toolbar -->
        <div class="toolbar flex flex-col">
            <!-- 1. Move Tool -->
            <div class="tool-group relative">
                <button class="tool-button active" data-tool="move" title="Move Tool (V)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,20H11V8L5.5,13.5L4.08,12.08L12,4.16L19.92,12.08L18.5,13.5L13,8V20Z"/>
                    </svg>
                </button>
            </div>

            <!-- 2. Marquee Selection Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="marquee" data-subtool="rectangular" title="Rectangular Marquee Tool (M)">â¬œ</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="marquee" data-subtool="rectangular" title="Rectangular Marquee">â¬œ</button>
                    <button class="tool-sub-button" data-tool="marquee" data-subtool="elliptical" title="Elliptical Marquee">â­•</button>
                    <button class="tool-sub-button" data-tool="marquee" data-subtool="single-row" title="Single Row Marquee">â”</button>
                    <button class="tool-sub-button" data-tool="marquee" data-subtool="single-column" title="Single Column Marquee">â”ƒ</button>
                </div>
            </div>

            <!-- 3. Lasso Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="lasso" data-subtool="freehand" title="Lasso Tool (L)">ğŸ¯</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="lasso" data-subtool="freehand" title="Lasso Tool">ğŸ¯</button>
                    <button class="tool-sub-button" data-tool="lasso" data-subtool="polygonal" title="Polygonal Lasso">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="lasso" data-subtool="magnetic" title="Magnetic Lasso">ğŸ§²</button>
                </div>
            </div>

            <!-- 4. Quick Selection / Magic Wand -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="selection" data-subtool="quick" title="Quick Selection Tool (W)">ğŸ§²</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="selection" data-subtool="quick" title="Quick Selection">ğŸ§²</button>
                    <button class="tool-sub-button" data-tool="selection" data-subtool="magic-wand" title="Magic Wand">ğŸª„</button>
                </div>
            </div>

            <!-- 5. Crop Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="crop" data-subtool="crop" title="Crop Tool (C)">âœ‚ï¸</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="crop" data-subtool="crop" title="Crop Tool">âœ‚ï¸</button>
                    <button class="tool-sub-button" data-tool="crop" data-subtool="perspective" title="Perspective Crop">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="crop" data-subtool="slice" title="Slice Tool">ğŸ”ª</button>
                    <button class="tool-sub-button" data-tool="crop" data-subtool="slice-select" title="Slice Select">ğŸ”²</button>
                </div>
            </div>

            <!-- 6. Eyedropper Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="eyedropper" data-subtool="eyedropper" title="Eyedropper Tool (I)">ğŸ’§</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="eyedropper" data-subtool="eyedropper" title="Eyedropper">ğŸ’§</button>
                    <button class="tool-sub-button" data-tool="eyedropper" data-subtool="3d-material" title="3D Material Eyedropper">ğŸ¨</button>
                    <button class="tool-sub-button" data-tool="eyedropper" data-subtool="color-sampler" title="Color Sampler">ğŸ¯</button>
                    <button class="tool-sub-button" data-tool="eyedropper" data-subtool="ruler" title="Ruler Tool">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="eyedropper" data-subtool="note" title="Note Tool">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="eyedropper" data-subtool="count" title="Count Tool">ğŸ”¢</button>
                </div>
            </div>

            <!-- 7. Healing Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="healing" data-subtool="spot-healing" title="Spot Healing Brush Tool (J)">ğŸ©¹</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="healing" data-subtool="spot-healing" title="Spot Healing Brush">ğŸ©¹</button>
                    <button class="tool-sub-button" data-tool="healing" data-subtool="healing-brush" title="Healing Brush">ğŸ–Œï¸</button>
                    <button class="tool-sub-button" data-tool="healing" data-subtool="patch" title="Patch Tool">ğŸ”§</button>
                    <button class="tool-sub-button" data-tool="healing" data-subtool="content-aware" title="Content-Aware Move">ğŸ“¦</button>
                    <button class="tool-sub-button" data-tool="healing" data-subtool="red-eye" title="Red Eye Tool">ğŸ‘ï¸</button>
                </div>
            </div>

            <!-- 8. Brush Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="brush" data-subtool="brush" title="Brush Tool (B)" onclick="showBrushPicker()">ğŸ–Œï¸</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="brush" data-subtool="round" title="Pincel Redondo">âš«</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="square" title="Pincel Quadrado">â¬›</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="soft-round" title="Pincel Redondo Suave">ğŸ”˜</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="hard-round" title="Pincel Redondo Duro">âš«</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="texture" title="Pincel Texturizado">ğŸ¨</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="watercolor" title="Pincel Aquarela">ğŸ’§</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="oil" title="Pincel Ã“leo">ğŸ–¼ï¸</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="chalk" title="Pincel Giz">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="charcoal" title="Pincel CarvÃ£o">âš«</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="airbrush" title="AerÃ³grafo">ğŸ’¨</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="pencil" title="LÃ¡pis">âœï¸</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="marker" title="Marcador">ğŸ–Šï¸</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="calligraphy" title="Caligrafia">ğŸ–‹ï¸</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="splatter" title="Respingo">ğŸ’¥</button>
                    <button class="tool-sub-button" data-tool="brush" data-subtool="stipple" title="Pontilhado">â‹¯</button>
                </div>
            </div>

            <!-- 9. Clone Stamp Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="clone" data-subtool="clone-stamp" title="Clone Stamp Tool (S)">ğŸ“‹</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="clone" data-subtool="clone-stamp" title="Clone Stamp">ğŸ“‹</button>
                    <button class="tool-sub-button" data-tool="clone" data-subtool="pattern-stamp" title="Pattern Stamp">ğŸ”³</button>
                </div>
            </div>

            <!-- 10. History Brush Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="history" data-subtool="history-brush" title="History Brush Tool (Y)">â®ï¸</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="history" data-subtool="history-brush" title="History Brush">â®ï¸</button>
                    <button class="tool-sub-button" data-tool="history" data-subtool="art-history" title="Art History Brush">ğŸ¨</button>
                </div>
            </div>

            <!-- 11. Eraser Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="eraser" data-subtool="eraser" title="Eraser Tool (E)">ğŸ§½</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="eraser" data-subtool="eraser" title="Eraser Tool">ğŸ§½</button>
                    <button class="tool-sub-button" data-tool="eraser" data-subtool="background" title="Background Eraser">ğŸ—‘ï¸</button>
                    <button class="tool-sub-button" data-tool="eraser" data-subtool="magic" title="Magic Eraser">âœ¨</button>
                </div>
            </div>

            <!-- 12. Gradient / Paint Bucket -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="fill" data-subtool="gradient" title="Gradient Tool (G)">ğŸŒˆ</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="fill" data-subtool="gradient" title="Gradient Tool">ğŸŒˆ</button>
                    <button class="tool-sub-button" data-tool="fill" data-subtool="paint-bucket" title="Paint Bucket">ğŸª£</button>
                    <button class="tool-sub-button" data-tool="fill" data-subtool="3d-material" title="3D Material Drop">ğŸ²</button>
                </div>
            </div>

            <!-- 13. Blur / Sharpen / Smudge -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="focus" data-subtool="blur" title="Blur Tool (R)">ğŸŒ«ï¸</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="focus" data-subtool="blur" title="Blur Tool">ğŸŒ«ï¸</button>
                    <button class="tool-sub-button" data-tool="focus" data-subtool="sharpen" title="Sharpen Tool">ğŸ”</button>
                    <button class="tool-sub-button" data-tool="focus" data-subtool="smudge" title="Smudge Tool">ğŸ‘†</button>
                </div>
            </div>

            <!-- 14. Dodge / Burn / Sponge -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="toning" data-subtool="dodge" title="Dodge Tool (O)">â˜€ï¸</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="toning" data-subtool="dodge" title="Dodge Tool">â˜€ï¸</button>
                    <button class="tool-sub-button" data-tool="toning" data-subtool="burn" title="Burn Tool">ğŸŒ™</button>
                    <button class="tool-sub-button" data-tool="toning" data-subtool="sponge" title="Sponge Tool">ğŸ§½</button>
                </div>
            </div>

            <!-- 15. Text Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="text" data-subtool="horizontal" title="Horizontal Type Tool (T)">T</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="text" data-subtool="horizontal" title="Horizontal Type">T</button>
                    <button class="tool-sub-button" data-tool="text" data-subtool="vertical" title="Vertical Type">ğŸ”„</button>
                    <button class="tool-sub-button" data-tool="text" data-subtool="horizontal-mask" title="Horizontal Type Mask">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="text" data-subtool="vertical-mask" title="Vertical Type Mask">ğŸ“„</button>
                </div>
            </div>

            <!-- 16. Path Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="path" data-subtool="pen" title="Pen Tool (P)">ğŸ–Šï¸</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="path" data-subtool="pen" title="Pen Tool">ğŸ–Šï¸</button>
                    <button class="tool-sub-button" data-tool="path" data-subtool="freeform-pen" title="Freeform Pen">âœ’ï¸</button>
                    <button class="tool-sub-button" data-tool="path" data-subtool="add-anchor" title="Add Anchor Point">â•</button>
                    <button class="tool-sub-button" data-tool="path" data-subtool="delete-anchor" title="Delete Anchor Point">â–</button>
                    <button class="tool-sub-button" data-tool="path" data-subtool="convert-point" title="Convert Point">ğŸ”„</button>
                </div>
            </div>

            <!-- 17. Shape Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="shape" data-subtool="rectangle" title="Rectangle Tool (U)">â¬œ</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="shape" data-subtool="rectangle" title="Rectangle">â¬œ</button>
                    <button class="tool-sub-button" data-tool="shape" data-subtool="ellipse" title="Ellipse">â­•</button>
                    <button class="tool-sub-button" data-tool="shape" data-subtool="triangle" title="Triangle">ğŸ”º</button>
                    <button class="tool-sub-button" data-tool="shape" data-subtool="polygon" title="Polygon">â¬Ÿ</button>
                    <button class="tool-sub-button" data-tool="shape" data-subtool="line" title="Line">ğŸ“</button>
                    <button class="tool-sub-button" data-tool="shape" data-subtool="custom" title="Custom Shape">â­</button>
                </div>
            </div>

            <!-- 18. Hand / Zoom Tools -->
            <div class="tool-group relative">
                <button class="tool-button" data-tool="navigation" data-subtool="hand" title="Hand Tool (H)">âœ‹</button>
                <div class="tool-submenu hidden absolute left-full top-0 bg-gray-800 border border-gray-600 rounded">
                    <button class="tool-sub-button" data-tool="navigation" data-subtool="hand" title="Hand Tool">âœ‹</button>
                    <button class="tool-sub-button" data-tool="navigation" data-subtool="zoom" title="Zoom Tool">ğŸ”</button>
                </div>
            </div>
            
            <!-- Color Swatches -->
            <div class="p-2 mt-4">
                <div class="color-picker mb-2" style="background: #000000;" id="foregroundColor" title="Foreground Color"></div>
                <div class="color-picker" style="background: #ffffff;" id="backgroundColor" title="Background Color"></div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="canvas-area flex-1 relative">
            <div class="canvas-container">
                <canvas id="mainCanvas" width="1000" height="1000" style="background: white; cursor: crosshair;"></canvas>
            </div>
            
            <!-- Tool Options Bar -->
            <div class="absolute top-0 left-0 right-0 bg-gray-800 border-b border-gray-600 p-2 flex items-center gap-4">
                <!-- Move Tool Options -->
                <div id="moveOptions" class="flex items-center gap-4">
                    <!-- Auto-Select -->
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="autoSelect" checked class="w-4 h-4">
                        <label for="autoSelect" class="text-xs text-white">Sel. Autom.</label>
                    </div>
                    
                    <!-- Layer/Group Dropdown -->
                    <select id="selectMode" class="bg-gray-700 text-white px-2 py-1 text-xs border border-gray-600 rounded">
                        <option value="layer">Camada</option>
                        <option value="group">Grupo</option>
                    </select>
                    
                    <!-- Show Transform Controls -->
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="showTransformControls" checked class="w-4 h-4">
                        <label for="showTransformControls" class="text-xs text-white">Mostrar Contr. Transf.</label>
                    </div>
                    
                    <!-- Alignment Tools -->
                    <div class="flex items-center gap-1 ml-4 border-l border-gray-600 pl-4">
                        <button id="alignTop" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Alinhar ao Topo">ğŸ¡¡</button>
                        <button id="alignVCenter" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Alinhar ao Centro Vertical">ğŸ¡£</button>
                        <button id="alignBottom" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Alinhar Ã  Base">ğŸ¡«</button>
                        <button id="alignLeft" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Alinhar Ã  Esquerda">ğŸ¡ </button>
                        <button id="alignHCenter" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Alinhar ao Centro Horizontal">ğŸ¡¢</button>
                        <button id="alignRight" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Alinhar Ã  Direita">ğŸ¡ª</button>
                    </div>
                    
                    <!-- Distribution Tools -->
                    <div class="flex items-center gap-1 ml-2 border-l border-gray-600 pl-2">
                        <button id="distributeH" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Distribuir Horizontalmente">âŸ·</button>
                        <button id="distributeV" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Distribuir Verticalmente">âŸµâŸ¶</button>
                    </div>
                    
                    <!-- More Options -->
                    <div class="flex items-center gap-2 ml-4 border-l border-gray-600 pl-4">
                        <button id="moreOptions" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="Mais OpÃ§Ãµes">...</button>
                        <button id="toolSettings" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 text-xs rounded" title="ConfiguraÃ§Ãµes da Ferramenta">âš™ï¸</button>
                    </div>
                </div>

                <!-- Brush Tool Options -->
                <div id="brushOptions" class="flex items-center gap-2 hidden">
                    <span class="text-xs">Size:</span>
                    <input type="range" id="brushSize" min="1" max="100" value="10" class="w-20">
                    <span id="brushSizeValue" class="text-xs w-8">10px</span>
                    <span class="text-xs ml-4">Opacity:</span>
                    <input type="range" id="brushOpacity" min="0" max="100" value="100" class="w-20">
                    <span id="brushOpacityValue" class="text-xs w-8">100%</span>
                </div>
                
                <!-- Text Tool Options -->
                <div id="textOptions" class="flex items-center gap-2 hidden">
                    <select id="fontFamily" class="bg-gray-700 text-white px-2 py-1 text-xs">
                        <option>Arial</option>
                        <option>Times New Roman</option>
                        <option>Helvetica</option>
                        <option>Georgia</option>
                    </select>
                    <input type="number" id="fontSize" value="24" min="8" max="200" class="bg-gray-700 text-white px-2 py-1 w-16 text-xs">
                    <button id="boldText" class="bg-gray-700 px-2 py-1 text-xs">B</button>
                    <button id="italicText" class="bg-gray-700 px-2 py-1 text-xs">I</button>
                </div>
            </div>
            
            <!-- Smart Panel (Painel Inteligente) -->
            <div class="absolute bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-600 p-3">
                <div class="flex items-center justify-center gap-4">
                    <button id="selectObjectBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        ğŸ§²ğŸ‘¤ Selecionar Objeto
                    </button>
                    <button id="removeBackgroundBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        âœ‚ï¸ Remover Fundo
                    </button>
                    <button id="autoColorBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        ğŸ¨ Ajustar Cores
                    </button>
                    <button id="autoEnhanceBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        âœ¨ Melhorar Imagem
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="layers-panel flex flex-col">
            <!-- Layers Panel -->
            <div class="flex-1">
                <div class="panel-header">Layers</div>
                <div class="p-2 border-b border-gray-600">
                    <div class="flex gap-1">
                        <button onclick="newLayer()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="New Layer">â•</button>
                        <button onclick="duplicateLayer()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="Duplicate">ğŸ“‘</button>
                        <button onclick="deleteLayer()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="Delete">ğŸ—‘ï¸</button>
                        <button onclick="addMask()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="Add Mask">ğŸ­</button>
                    </div>
                </div>
                
                <div id="layersList">
                    <div class="layer-item" data-layer="1">
                        <div class="layer-thumbnail">ğŸ“</div>
                        <div class="flex-1">
                            <div class="font-medium">Camada 1</div>
                            <div class="text-xs text-gray-400">Normal â€¢ 100%</div>
                        </div>
                        <div class="text-xs">ğŸ‘ï¸</div>
                    </div>
                    <div class="layer-item active" data-layer="0">
                        <div class="layer-thumbnail">ğŸ”’</div>
                        <div class="flex-1">
                            <div class="font-medium">Plano de Fundo</div>
                            <div class="text-xs text-gray-400">Normal â€¢ 100%</div>
                        </div>
                        <div class="text-xs">ğŸ‘ï¸</div>
                    </div>
                </div>
                
                <!-- Layer Action Buttons -->
                <div class="p-2 border-t border-gray-600">
                    <div class="flex gap-1 justify-center">
                        <button onclick="addLayerEffect()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 text-xs rounded" title="Layer Effects">fx</button>
                        <button onclick="addLayerMask()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="Add Layer Mask">ğŸ”˜</button>
                        <button onclick="newLayer()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="New Layer">ğŸ“„</button>
                        <button onclick="deleteLayer()" class="bg-gray-600 hover:bg-gray-500 px-2 py-1 text-xs rounded" title="Delete Layer">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-panel border-t border-gray-600">
                <div class="panel-header">Properties</div>
                
                <div class="slider-control">
                    <label>Opacity</label>
                    <input type="range" id="layerOpacity" min="0" max="100" value="100" onchange="updateOpacity(this.value)">
                    <span id="opacityValue" class="text-xs">100%</span>
                </div>
                
                <div class="slider-control">
                    <label>Blend Mode</label>
                    <select id="blendMode" class="w-full bg-gray-700 text-white px-2 py-1 text-xs" onchange="updateBlendMode(this.value)">
                        <option value="normal">Normal</option>
                        <option value="multiply">Multiply</option>
                        <option value="screen">Screen</option>
                        <option value="overlay">Overlay</option>
                        <option value="soft-light">Soft Light</option>
                        <option value="hard-light">Hard Light</option>
                        <option value="color-dodge">Color Dodge</option>
                        <option value="color-burn">Color Burn</option>
                    </select>
                </div>

                <!-- Adjustments -->
                <div class="mt-4">
                    <div class="panel-header">Adjustments</div>
                    
                    <div class="slider-control">
                        <label>Brightness</label>
                        <input type="range" id="brightness" min="-100" max="100" value="0" onchange="applyAdjustments()">
                        <span id="brightnessValue" class="text-xs">0</span>
                    </div>
                    
                    <div class="slider-control">
                        <label>Contrast</label>
                        <input type="range" id="contrast" min="-100" max="100" value="0" onchange="applyAdjustments()">
                        <span id="contrastValue" class="text-xs">0</span>
                    </div>
                    
                    <div class="slider-control">
                        <label>Saturation</label>
                        <input type="range" id="saturation" min="-100" max="100" value="0" onchange="applyAdjustments()">
                        <span id="saturationValue" class="text-xs">0</span>
                    </div>
                </div>

                <!-- Filters -->
                <div class="mt-4">
                    <div class="panel-header">Filters</div>
                    <div class="filter-grid">
                        <button class="filter-button" onclick="applyFilter('blur')">Blur</button>
                        <button class="filter-button" onclick="applyFilter('sharpen')">Sharpen</button>
                        <button class="filter-button" onclick="applyFilter('emboss')">Emboss</button>
                        <button class="filter-button" onclick="applyFilter('edge')">Edge</button>
                        <button class="filter-button" onclick="applyFilter('vintage')">Vintage</button>
                        <button class="filter-button" onclick="applyFilter('sepia')">Sepia</button>
                    </div>
                </div>
            </div>

            <!-- History Panel -->
            <div class="border-t border-gray-600">
                <div class="panel-header">History</div>
                <div id="historyList" class="max-h-32 overflow-y-auto">
                    <div class="history-item">ğŸ“„ New Document</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="canvasInfo">800 x 600 px â€¢ RGB/8</span>
        <span id="zoomLevel">100%</span>
        <span id="toolInfo">Move Tool</span>
        <span id="memoryUsage">Memory: 45.2MB</span>
        <span class="ml-auto text-xs">
            Criado por <a href="https://www.instagram.com/paulo_henrique_fotografo/" target="_blank" class="text-blue-400 hover:text-blue-300">Paulo Henrique</a>
        </span>
    </div>

    <!-- Offline Game -->
    <div id="offlineGame" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 hidden">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">ğŸ® Jogo da InformÃ¡tica</h1>
            <p class="text-gray-300 mb-2">Sem conexÃ£o com a internet!</p>
            <p class="text-gray-400 text-sm">Use as setas â† â†’ para mover e ESPAÃ‡O para atirar</p>
        </div>
        
        <canvas id="gameCanvas" width="800" height="400" class="border-2 border-gray-600 bg-black"></canvas>
        
        <div class="mt-4 text-center">
            <div class="text-white mb-2">PontuaÃ§Ã£o: <span id="gameScore">0</span></div>
            <button onclick="startGame()" id="startGameBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Iniciar Jogo</button>
            <button onclick="hideOfflineGame()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white ml-2">Voltar ao Editor</button>
        </div>
        
        <div class="mt-4 text-center text-gray-400 text-sm">
            <p>Criado por <a href="https://www.instagram.com/paulo_henrique_fotografo/" target="_blank" class="text-blue-400 hover:text-blue-300">Paulo Henrique</a></p>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="loadImage(event)">

    <script>
        // Global variables
        let canvas = document.getElementById('mainCanvas');
        let ctx = canvas.getContext('2d');
        let currentTool = 'move';
        let currentSubtool = 'default';
        let isDrawing = false;
        let layers = [
            { name: 'Camada 1', visible: true, opacity: 100, data: null },
            { name: 'Plano de Fundo', visible: true, opacity: 100, data: null }
        ];
        let currentLayer = 0;
        let history = [];
        let historyStep = 0;
        let originalImageData = null;
        
        // New variables for moveable elements
        let elements = []; // Array to store all moveable elements (photos, text, shapes)
        let selectedElement = null;
        let selectedElements = []; // Array for multi-selection
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeHandle = null;
        let elementCounter = 0;
        let isCtrlPressed = false;

        // Tool selection
        document.querySelectorAll('.tool-button, .tool-sub-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tool-button').forEach(b => b.classList.remove('active'));
                
                // Find the main tool button for this group
                const mainButton = this.classList.contains('tool-sub-button') 
                    ? this.closest('.tool-group').querySelector('.tool-button')
                    : this;
                
                mainButton.classList.add('active');
                
                currentTool = this.dataset.tool;
                currentSubtool = this.dataset.subtool || 'default';
                
                // Update main button icon if subtool was selected
                if (this.classList.contains('tool-sub-button')) {
                    mainButton.innerHTML = this.innerHTML.split(' ')[0]; // Get just the icon
                    mainButton.title = this.title;
                }
                
                updateToolOptions();
                updateStatusBar();
                
                // Hide submenu
                document.querySelectorAll('.tool-submenu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            });
        });
        
        // Show/hide submenus on hover
        document.querySelectorAll('.tool-group').forEach(group => {
            const submenu = group.querySelector('.tool-submenu');
            if (submenu) {
                group.addEventListener('mouseenter', () => {
                    submenu.classList.remove('hidden');
                });
                group.addEventListener('mouseleave', () => {
                    submenu.classList.add('hidden');
                });
            }
        });

        // Update tool options based on selected tool
        function updateToolOptions() {
            document.querySelectorAll('[id$="Options"]').forEach(el => el.classList.add('hidden'));
            
            if (currentTool === 'move') {
                document.getElementById('moveOptions').classList.remove('hidden');
            } else if (currentTool === 'brush' || currentTool === 'eraser') {
                document.getElementById('brushOptions').classList.remove('hidden');
            } else if (currentTool === 'text') {
                document.getElementById('textOptions').classList.remove('hidden');
            }
        }

        // Element class for moveable objects
        class Element {
            constructor(type, x, y, width, height) {
                this.id = ++elementCounter;
                this.type = type; // 'image', 'text', 'shape'
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.rotation = 0;
                this.opacity = 1;
                this.visible = true;
                this.selected = false;
                this.data = null; // Image data, text content, etc.
                this.style = {}; // Font, color, etc.
            }
            
            contains(x, y) {
                return x >= this.x && x <= this.x + this.width &&
                       y >= this.y && y <= this.y + this.height;
            }
            
            getResizeHandle(x, y) {
                const handleSize = 8;
                const handles = [
                    { name: 'nw', x: this.x - handleSize/2, y: this.y - handleSize/2 },
                    { name: 'ne', x: this.x + this.width - handleSize/2, y: this.y - handleSize/2 },
                    { name: 'sw', x: this.x - handleSize/2, y: this.y + this.height - handleSize/2 },
                    { name: 'se', x: this.x + this.width - handleSize/2, y: this.y + this.height - handleSize/2 },
                    { name: 'n', x: this.x + this.width/2 - handleSize/2, y: this.y - handleSize/2 },
                    { name: 's', x: this.x + this.width/2 - handleSize/2, y: this.y + this.height - handleSize/2 },
                    { name: 'w', x: this.x - handleSize/2, y: this.y + this.height/2 - handleSize/2 },
                    { name: 'e', x: this.x + this.width - handleSize/2, y: this.y + this.height/2 - handleSize/2 }
                ];
                
                for (let handle of handles) {
                    if (x >= handle.x && x <= handle.x + handleSize &&
                        y >= handle.y && y <= handle.y + handleSize) {
                        return handle.name;
                    }
                }
                return null;
            }
            
            draw(ctx) {
                if (!this.visible) return;
                
                ctx.save();
                ctx.globalAlpha = this.opacity;
                
                // Apply CSS filters if available
                if (this.filters) {
                    ctx.filter = this.filters;
                }
                
                // Apply effects before drawing the element
                if (this.effects) {
                    this.applyEffects(ctx);
                }
                
                if (this.type === 'image' && this.data) {
                    ctx.drawImage(this.data, this.x, this.y, this.width, this.height);
                } else if (this.type === 'text' && this.data) {
                    let fontString = '';
                    if (this.style.fontWeight === 'bold') fontString += 'bold ';
                    if (this.style.fontStyle === 'italic') fontString += 'italic ';
                    fontString += `${this.style.fontSize || 24}px ${this.style.fontFamily || 'Arial'}`;
                    
                    ctx.font = fontString;
                    ctx.fillStyle = this.style.color || '#000000';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    
                    if (this.style.textDecoration === 'underline') {
                        ctx.fillText(this.data, this.x, this.y);
                        const textWidth = ctx.measureText(this.data).width;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y + this.height + 2);
                        ctx.lineTo(this.x + textWidth, this.y + this.height + 2);
                        ctx.strokeStyle = this.style.color || '#000000';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    } else {
                        ctx.fillText(this.data, this.x, this.y);
                    }
                } else if (this.type === 'shape') {
                    ctx.fillStyle = this.style.fillColor || '#0078d4';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }
                
                // Draw selection handles if selected
                if (this.selected) {
                    this.drawSelectionHandles(ctx);
                }
                
                ctx.restore();
            }
            
            applyEffects(ctx) {
                // Drop Shadow
                if (this.effects.dropShadow) {
                    const shadow = this.effects.dropShadow;
                    ctx.shadowColor = shadow.color;
                    ctx.shadowBlur = shadow.blur;
                    ctx.shadowOffsetX = shadow.distance;
                    ctx.shadowOffsetY = shadow.distance;
                    ctx.globalAlpha = shadow.opacity;
                }
                
                // Outer Glow (simplified as shadow with no offset)
                if (this.effects.outerGlow) {
                    const glow = this.effects.outerGlow;
                    ctx.shadowColor = glow.color;
                    ctx.shadowBlur = glow.size;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                    ctx.globalAlpha = glow.intensity;
                }
                
                // Stroke (will be applied after main drawing)
                if (this.effects.stroke) {
                    const stroke = this.effects.stroke;
                    ctx.strokeStyle = stroke.color;
                    ctx.lineWidth = stroke.size;
                }
            }
            
            drawSelectionHandles(ctx) {
                const handleSize = 8;
                ctx.fillStyle = '#0078d4';
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1;
                
                // Selection border
                ctx.strokeRect(this.x - 1, this.y - 1, this.width + 2, this.height + 2);
                
                // Corner and edge handles
                const handles = [
                    { x: this.x - handleSize/2, y: this.y - handleSize/2 }, // nw
                    { x: this.x + this.width - handleSize/2, y: this.y - handleSize/2 }, // ne
                    { x: this.x - handleSize/2, y: this.y + this.height - handleSize/2 }, // sw
                    { x: this.x + this.width - handleSize/2, y: this.y + this.height - handleSize/2 }, // se
                    { x: this.x + this.width/2 - handleSize/2, y: this.y - handleSize/2 }, // n
                    { x: this.x + this.width/2 - handleSize/2, y: this.y + this.height - handleSize/2 }, // s
                    { x: this.x - handleSize/2, y: this.y + this.height/2 - handleSize/2 }, // w
                    { x: this.x + this.width - handleSize/2, y: this.y + this.height/2 - handleSize/2 } // e
                ];
                
                handles.forEach(handle => {
                    ctx.fillRect(handle.x, handle.y, handleSize, handleSize);
                    ctx.strokeRect(handle.x, handle.y, handleSize, handleSize);
                });
            }
        }

        // Canvas drawing events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        function startDrawing(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (currentTool === 'move') {
                handleMoveToolMouseDown(x, y);
                return;
            }
            
            if (currentTool === 'text') {
                addText(e);
                return;
            }
            
            isDrawing = true;
            
            if (currentTool === 'brush') {
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            saveState();
        }

        function draw(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (currentTool === 'move') {
                handleMoveToolMouseMove(x, y);
                updateCursor(x, y);
                return;
            }
            
            if (!isDrawing) return;
            
            if (currentTool === 'brush') {
                drawWithBrush(x, y);
            } else if (currentTool === 'eraser') {
                const size = document.getElementById('brushSize').value;
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, size/2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        function stopDrawing(e) {
            if (currentTool === 'move') {
                handleMoveToolMouseUp();
                return;
            }
            
            isDrawing = false;
            ctx.globalAlpha = 1;
        }

        // Move tool functions
        function handleMoveToolMouseDown(x, y) {
            // Check if clicking on a resize handle first
            if (selectedElement && !isCtrlPressed) {
                resizeHandle = selectedElement.getResizeHandle(x, y);
                if (resizeHandle) {
                    isResizing = true;
                    return;
                }
            }
            
            // Check if clicking on an element
            let clickedElement = null;
            for (let i = elements.length - 1; i >= 0; i--) {
                if (elements[i].contains(x, y)) {
                    clickedElement = elements[i];
                    break;
                }
            }
            
            if (clickedElement) {
                if (isCtrlPressed) {
                    // Multi-selection with Ctrl
                    clickedElement.selected = !clickedElement.selected;
                    if (clickedElement.selected) {
                        selectedElements.push(clickedElement);
                        showNotification(`ğŸ¯ Elemento adicionado Ã  seleÃ§Ã£o! Total: ${selectedElements.length}`);
                    } else {
                        selectedElements = selectedElements.filter(el => el !== clickedElement);
                        showNotification(`â– Elemento removido da seleÃ§Ã£o! Total: ${selectedElements.length}`);
                    }
                    selectedElement = selectedElements.length > 0 ? selectedElements[selectedElements.length - 1] : null;
                } else {
                    // Single selection
                    elements.forEach(el => el.selected = false);
                    selectedElements = [];
                    
                    clickedElement.selected = true;
                    selectedElement = clickedElement;
                    selectedElements = [clickedElement];
                    
                    isDragging = true;
                    dragOffset.x = x - clickedElement.x;
                    dragOffset.y = y - clickedElement.y;
                    
                    if (document.getElementById('autoSelect').checked) {
                        showNotification(`ğŸ¯ Elemento "${clickedElement.type}" selecionado!`);
                    }
                }
            } else if (!isCtrlPressed) {
                // Deselect all if clicking empty area without Ctrl
                elements.forEach(el => el.selected = false);
                selectedElement = null;
                selectedElements = [];
            }
            
            redrawCanvas();
        }
        
        // Edit text element
        function editTextElement(textElement) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-96">
                    <h3 class="text-white text-lg font-bold mb-4">ğŸ“ Editar Texto</h3>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Texto:</label>
                        <textarea id="editTextContent" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 h-24 resize-none" placeholder="Digite seu texto aqui...">${textElement.data}</textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm mb-2">Fonte:</label>
                            <select id="editFontFamily" class="w-full bg-gray-700 text-white px-2 py-1 text-xs border border-gray-600 rounded">
                                <option value="Arial" ${textElement.style.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
                                <option value="Times New Roman" ${textElement.style.fontFamily === 'Times New Roman' ? 'selected' : ''}>Times New Roman</option>
                                <option value="Helvetica" ${textElement.style.fontFamily === 'Helvetica' ? 'selected' : ''}>Helvetica</option>
                                <option value="Georgia" ${textElement.style.fontFamily === 'Georgia' ? 'selected' : ''}>Georgia</option>
                                <option value="Verdana" ${textElement.style.fontFamily === 'Verdana' ? 'selected' : ''}>Verdana</option>
                                <option value="Comic Sans MS" ${textElement.style.fontFamily === 'Comic Sans MS' ? 'selected' : ''}>Comic Sans MS</option>
                                <option value="Impact" ${textElement.style.fontFamily === 'Impact' ? 'selected' : ''}>Impact</option>
                                <option value="Courier New" ${textElement.style.fontFamily === 'Courier New' ? 'selected' : ''}>Courier New</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-2">Tamanho:</label>
                            <input type="number" id="editFontSize" value="${textElement.style.fontSize || 24}" min="8" max="200" class="w-full bg-gray-700 text-white px-2 py-1 text-xs border border-gray-600 rounded">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Cor:</label>
                        <input type="color" id="editTextColor" value="${textElement.style.color || '#000000'}" class="w-full h-10 bg-gray-700 border border-gray-600 rounded cursor-pointer">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Estilo:</label>
                        <div class="flex gap-2">
                            <button id="editBold" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white font-bold ${textElement.style.fontWeight === 'bold' ? 'bg-blue-600' : ''}">B</button>
                            <button id="editItalic" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white italic ${textElement.style.fontStyle === 'italic' ? 'bg-blue-600' : ''}">I</button>
                            <button id="editUnderline" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white underline ${textElement.style.textDecoration === 'underline' ? 'bg-blue-600' : ''}">U</button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end">
                        <button onclick="closeTextEditor()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Cancelar</button>
                        <button onclick="saveTextChanges()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Salvar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentTextEditor = { dialog, textElement };
            
            // Style buttons functionality
            dialog.querySelector('#editBold').addEventListener('click', function() {
                this.classList.toggle('bg-blue-600');
            });
            dialog.querySelector('#editItalic').addEventListener('click', function() {
                this.classList.toggle('bg-blue-600');
            });
            dialog.querySelector('#editUnderline').addEventListener('click', function() {
                this.classList.toggle('bg-blue-600');
            });
        }
        
        function closeTextEditor() {
            if (window.currentTextEditor) {
                window.currentTextEditor.dialog.remove();
                window.currentTextEditor = null;
            }
        }
        
        function saveTextChanges() {
            if (window.currentTextEditor) {
                const { textElement } = window.currentTextEditor;
                const dialog = window.currentTextEditor.dialog;
                
                const newText = dialog.querySelector('#editTextContent').value;
                const fontSize = parseInt(dialog.querySelector('#editFontSize').value);
                const fontFamily = dialog.querySelector('#editFontFamily').value;
                const color = dialog.querySelector('#editTextColor').value;
                const isBold = dialog.querySelector('#editBold').classList.contains('bg-blue-600');
                const isItalic = dialog.querySelector('#editItalic').classList.contains('bg-blue-600');
                const isUnderline = dialog.querySelector('#editUnderline').classList.contains('bg-blue-600');
                
                // Update text element
                textElement.data = newText;
                textElement.style.fontSize = fontSize;
                textElement.style.fontFamily = fontFamily;
                textElement.style.color = color;
                textElement.style.fontWeight = isBold ? 'bold' : 'normal';
                textElement.style.fontStyle = isItalic ? 'italic' : 'normal';
                textElement.style.textDecoration = isUnderline ? 'underline' : 'none';
                
                // Recalculate text dimensions
                ctx.font = `${isBold ? 'bold ' : ''}${isItalic ? 'italic ' : ''}${fontSize}px ${fontFamily}`;
                const textMetrics = ctx.measureText(newText);
                textElement.width = textMetrics.width;
                textElement.height = fontSize;
                
                redrawCanvas();
                updateLayersList();
                addToHistory('Edit Text');
                saveState();
                showNotification('ğŸ“ Texto atualizado!');
                
                closeTextEditor();
            }
        }
        
        function handleMoveToolMouseMove(x, y) {
            if (isResizing && selectedElement && resizeHandle) {
                resizeElement(selectedElement, x, y, resizeHandle);
                redrawCanvas();
            } else if (isDragging && selectedElements.length > 0) {
                // Move all selected elements
                const deltaX = x - dragOffset.x - selectedElement.x;
                const deltaY = y - dragOffset.y - selectedElement.y;
                
                selectedElements.forEach(element => {
                    element.x += deltaX;
                    element.y += deltaY;
                });
                
                // Update drag offset for next frame
                dragOffset.x = x - selectedElement.x;
                dragOffset.y = y - selectedElement.y;
                
                redrawCanvas();
            }
        }
        
        function handleMoveToolMouseUp() {
            if (isDragging || isResizing) {
                addToHistory('Move/Resize Element');
                saveState();
            }
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        }
        
        function resizeElement(element, mouseX, mouseY, handle) {
            const minSize = 10;
            
            switch(handle) {
                case 'nw':
                    const newWidth = element.width + (element.x - mouseX);
                    const newHeight = element.height + (element.y - mouseY);
                    if (newWidth > minSize && newHeight > minSize) {
                        element.x = mouseX;
                        element.y = mouseY;
                        element.width = newWidth;
                        element.height = newHeight;
                    }
                    break;
                case 'ne':
                    const newWidth2 = mouseX - element.x;
                    const newHeight2 = element.height + (element.y - mouseY);
                    if (newWidth2 > minSize && newHeight2 > minSize) {
                        element.y = mouseY;
                        element.width = newWidth2;
                        element.height = newHeight2;
                    }
                    break;
                case 'sw':
                    const newWidth3 = element.width + (element.x - mouseX);
                    const newHeight3 = mouseY - element.y;
                    if (newWidth3 > minSize && newHeight3 > minSize) {
                        element.x = mouseX;
                        element.width = newWidth3;
                        element.height = newHeight3;
                    }
                    break;
                case 'se':
                    const newWidth4 = mouseX - element.x;
                    const newHeight4 = mouseY - element.y;
                    if (newWidth4 > minSize && newHeight4 > minSize) {
                        element.width = newWidth4;
                        element.height = newHeight4;
                    }
                    break;
                case 'n':
                    const newHeight5 = element.height + (element.y - mouseY);
                    if (newHeight5 > minSize) {
                        element.y = mouseY;
                        element.height = newHeight5;
                    }
                    break;
                case 's':
                    const newHeight6 = mouseY - element.y;
                    if (newHeight6 > minSize) {
                        element.height = newHeight6;
                    }
                    break;
                case 'w':
                    const newWidth7 = element.width + (element.x - mouseX);
                    if (newWidth7 > minSize) {
                        element.x = mouseX;
                        element.width = newWidth7;
                    }
                    break;
                case 'e':
                    const newWidth8 = mouseX - element.x;
                    if (newWidth8 > minSize) {
                        element.width = newWidth8;
                    }
                    break;
            }
        }
        
        function updateCursor(x, y) {
            let cursor = 'default';
            
            if (selectedElement) {
                const handle = selectedElement.getResizeHandle(x, y);
                if (handle) {
                    const cursors = {
                        'nw': 'nw-resize',
                        'ne': 'ne-resize',
                        'sw': 'sw-resize',
                        'se': 'se-resize',
                        'n': 'n-resize',
                        's': 's-resize',
                        'w': 'w-resize',
                        'e': 'e-resize'
                    };
                    cursor = cursors[handle];
                } else if (selectedElement.contains(x, y)) {
                    cursor = 'move';
                }
            } else {
                // Check if hovering over any element
                for (let element of elements) {
                    if (element.contains(x, y)) {
                        cursor = 'move';
                        break;
                    }
                }
            }
            
            canvas.style.cursor = cursor;
        }

        // Text tool
        function addText(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const text = prompt('Digite o texto:');
            if (text) {
                const fontSize = parseInt(document.getElementById('fontSize').value) || 24;
                const fontFamily = document.getElementById('fontFamily').value || 'Arial';
                const color = document.getElementById('foregroundColor').style.background || '#000000';
                
                // Create text element
                const textElement = new Element('text', x, y, text.length * fontSize * 0.6, fontSize);
                textElement.data = text;
                textElement.style = {
                    fontSize: fontSize,
                    fontFamily: fontFamily,
                    color: color
                };
                
                elements.push(textElement);
                
                // Select the new text element
                elements.forEach(el => el.selected = false);
                textElement.selected = true;
                selectedElement = textElement;
                
                redrawCanvas();
                updateLayersList();
                addToHistory('Add Text');
                saveState();
                showNotification('ğŸ“ Texto adicionado! Use a ferramenta Move para mover e redimensionar.');
            }
        }

        // File operations
        function openFile() {
            document.getElementById('fileInput').click();
        }

        function loadImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Calculate position to center the image
                        const x = (canvas.width - img.width) / 2;
                        const y = (canvas.height - img.height) / 2;
                        
                        // Create image element
                        const imageElement = new Element('image', Math.max(0, x), Math.max(0, y), img.width, img.height);
                        imageElement.data = img;
                        
                        elements.push(imageElement);
                        
                        // Select the new image element
                        elements.forEach(el => el.selected = false);
                        imageElement.selected = true;
                        selectedElement = imageElement;
                        
                        redrawCanvas();
                        updateLayersList();
                        updateCanvasInfo();
                        addToHistory('Add Image');
                        saveState();
                        showNotification('ğŸ–¼ï¸ Imagem adicionada! Use a ferramenta Move para mover e redimensionar.');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Add multiple images function
        function addImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(event) {
                const files = event.target.files;
                let loadedCount = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // Position images in a grid
                            const gridSize = Math.ceil(Math.sqrt(files.length));
                            const row = Math.floor(loadedCount / gridSize);
                            const col = loadedCount % gridSize;
                            const spacing = 20;
                            const maxSize = 200;
                            
                            // Scale image to fit max size while maintaining aspect ratio
                            let width = img.width;
                            let height = img.height;
                            if (width > maxSize || height > maxSize) {
                                const scale = Math.min(maxSize / width, maxSize / height);
                                width *= scale;
                                height *= scale;
                            }
                            
                            const x = col * (maxSize + spacing) + 50;
                            const y = row * (maxSize + spacing) + 50;
                            
                            // Create image element
                            const imageElement = new Element('image', x, y, width, height);
                            imageElement.data = img;
                            
                            elements.push(imageElement);
                            loadedCount++;
                            
                            if (loadedCount === files.length) {
                                redrawCanvas();
                                updateLayersList();
                                addToHistory(`Add ${files.length} Images`);
                                saveState();
                                showNotification(`ğŸ–¼ï¸ ${files.length} imagens adicionadas!`);
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // Store background image data
        let fixedBackgroundData = null;
        
        // Redraw canvas with all elements
        function redrawCanvas() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // If there's a fixed background, draw it first
            if (fixedBackgroundData) {
                ctx.putImageData(fixedBackgroundData, 0, 0);
            } else {
                // Fill with white background if no fixed background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Draw all elements
            elements.forEach(element => {
                element.draw(ctx);
            });
        }

        function saveFile() {
            const link = document.createElement('a');
            link.download = 'photoshop-edit.png';
            link.href = canvas.toDataURL();
            link.click();
            showNotification('ğŸ’¾ Image saved successfully!');
        }

        function exportFile() {
            showExportDialog();
        }

        function showExportDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-96">
                    <h3 class="text-white text-lg font-bold mb-4">ğŸ“¤ Exportar Imagem</h3>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Formato:</label>
                        <select id="exportFormat" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600">
                            <option value="png">PNG (TransparÃªncia)</option>
                            <option value="jpeg">JPG (Menor tamanho)</option>
                            <option value="webp">WebP (Moderno)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Qualidade (JPG/WebP):</label>
                        <input type="range" id="exportQuality" min="10" max="100" value="90" class="w-full">
                        <span id="qualityValue" class="text-white text-xs">90%</span>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Tamanho:</label>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="exportWidth" value="${canvas.width}" class="bg-gray-700 text-white px-2 py-1 rounded w-20" placeholder="Largura">
                            <span class="text-white self-center">x</span>
                            <input type="number" id="exportHeight" value="${canvas.height}" class="bg-gray-700 text-white px-2 py-1 rounded w-20" placeholder="Altura">
                            <button id="lockAspect" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs" title="Manter ProporÃ§Ã£o">ğŸ”—</button>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="setExportSize(800, 600)" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">800x600</button>
                            <button onclick="setExportSize(1920, 1080)" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">1920x1080</button>
                            <button onclick="setExportSize(1080, 1080)" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">1080x1080</button>
                            <button onclick="setExportSize(500, 500)" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">500x500</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Nome do arquivo:</label>
                        <input type="text" id="exportFilename" value="photoshop-edit" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600">
                    </div>
                    
                    <div class="flex gap-2 justify-end">
                        <button onclick="closeExportDialog()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Cancelar</button>
                        <button onclick="performExport()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Exportar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // Quality slider update
            dialog.querySelector('#exportQuality').addEventListener('input', function() {
                dialog.querySelector('#qualityValue').textContent = this.value + '%';
            });
            
            // Aspect ratio lock
            let aspectLocked = true;
            const originalAspect = canvas.width / canvas.height;
            
            dialog.querySelector('#lockAspect').addEventListener('click', function() {
                aspectLocked = !aspectLocked;
                this.style.background = aspectLocked ? '#0078d4' : '#4a4a4a';
            });
            
            dialog.querySelector('#exportWidth').addEventListener('input', function() {
                if (aspectLocked) {
                    dialog.querySelector('#exportHeight').value = Math.round(this.value / originalAspect);
                }
            });
            
            dialog.querySelector('#exportHeight').addEventListener('input', function() {
                if (aspectLocked) {
                    dialog.querySelector('#exportWidth').value = Math.round(this.value * originalAspect);
                }
            });
            
            window.currentExportDialog = dialog;
        }

        function setExportSize(width, height) {
            document.getElementById('exportWidth').value = width;
            document.getElementById('exportHeight').value = height;
        }

        function closeExportDialog() {
            if (window.currentExportDialog) {
                window.currentExportDialog.remove();
                window.currentExportDialog = null;
            }
        }

        function performExport() {
            const format = document.getElementById('exportFormat').value;
            const quality = document.getElementById('exportQuality').value / 100;
            const width = parseInt(document.getElementById('exportWidth').value);
            const height = parseInt(document.getElementById('exportHeight').value);
            const filename = document.getElementById('exportFilename').value;
            
            // Create temporary canvas for resizing
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            // Fill with white background
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, width, height);
            
            // Calculate scale factors
            const scaleX = width / canvas.width;
            const scaleY = height / canvas.height;
            
            // Draw all elements scaled
            elements.forEach(element => {
                if (!element.visible) return;
                
                tempCtx.save();
                tempCtx.globalAlpha = element.opacity;
                
                const scaledX = element.x * scaleX;
                const scaledY = element.y * scaleY;
                const scaledWidth = element.width * scaleX;
                const scaledHeight = element.height * scaleY;
                
                if (element.type === 'image' && element.data) {
                    tempCtx.drawImage(element.data, scaledX, scaledY, scaledWidth, scaledHeight);
                } else if (element.type === 'text' && element.data) {
                    const scaledFontSize = (element.style.fontSize || 24) * Math.min(scaleX, scaleY);
                    tempCtx.font = `${scaledFontSize}px ${element.style.fontFamily || 'Arial'}`;
                    tempCtx.fillStyle = element.style.color || '#000000';
                    tempCtx.textAlign = 'left';
                    tempCtx.textBaseline = 'top';
                    tempCtx.fillText(element.data, scaledX, scaledY);
                } else if (element.type === 'shape') {
                    tempCtx.fillStyle = element.style.fillColor || '#0078d4';
                    tempCtx.fillRect(scaledX, scaledY, scaledWidth, scaledHeight);
                }
                
                tempCtx.restore();
            });
            
            // Export with quality
            let mimeType = 'image/png';
            let extension = 'png';
            
            if (format === 'jpeg') {
                mimeType = 'image/jpeg';
                extension = 'jpg';
            } else if (format === 'webp') {
                mimeType = 'image/webp';
                extension = 'webp';
            }
            
            const link = document.createElement('a');
            link.download = `${filename}.${extension}`;
            link.href = tempCanvas.toDataURL(mimeType, quality);
            link.click();
            
            closeExportDialog();
            showNotification(`ğŸ“¤ Exportado como ${format.toUpperCase()} (${width}x${height})!`);
        }

        function newDocument() {
            showCanvasSizeDialog();
        }

        function showCanvasSizeDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-96">
                    <h3 class="text-white text-lg font-bold mb-4">ğŸ“ Configurar Tamanho da Tela</h3>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Presets RÃ¡pidos:</label>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button onclick="setCanvasSize(1000, 1000)" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white text-sm">1000x1000 (Quadrado)</button>
                            <button onclick="setCanvasSize(1920, 1080)" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white text-sm">1920x1080 (HD)</button>
                            <button onclick="setCanvasSize(1080, 1080)" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white text-sm">1080x1080 (Instagram)</button>
                            <button onclick="setCanvasSize(1200, 630)" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white text-sm">1200x630 (Facebook)</button>
                            <button onclick="setCanvasSize(800, 600)" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white text-sm">800x600 (ClÃ¡ssico)</button>
                            <button onclick="setCanvasSize(500, 500)" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-white text-sm">500x500 (Pequeno)</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm mb-2">Largura (px):</label>
                            <input type="number" id="canvasWidth" value="${canvas.width}" min="100" max="5000" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600">
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-2">Altura (px):</label>
                            <input type="number" id="canvasHeight" value="${canvas.height}" min="100" max="5000" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center gap-2 text-white text-sm">
                            <input type="checkbox" id="maintainAspectRatio" class="w-4 h-4">
                            Manter proporÃ§Ã£o
                        </label>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Cor de fundo:</label>
                        <div class="flex gap-2">
                            <button onclick="setBackgroundColor('#ffffff')" class="w-8 h-8 bg-white border-2 border-gray-600 rounded" title="Branco"></button>
                            <button onclick="setBackgroundColor('#000000')" class="w-8 h-8 bg-black border-2 border-gray-600 rounded" title="Preto"></button>
                            <button onclick="setBackgroundColor('transparent')" class="w-8 h-8 border-2 border-gray-600 rounded" style="background: repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px;" title="Transparente"></button>
                            <input type="color" id="customBackgroundColor" value="#ffffff" class="w-8 h-8 border-2 border-gray-600 rounded cursor-pointer" title="Cor personalizada">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end">
                        <button onclick="closeCanvasSizeDialog()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Cancelar</button>
                        <button onclick="applyCanvasSize()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Aplicar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentCanvasSizeDialog = dialog;
            
            // Aspect ratio maintenance
            const aspectRatio = canvas.width / canvas.height;
            const widthInput = dialog.querySelector('#canvasWidth');
            const heightInput = dialog.querySelector('#canvasHeight');
            const maintainRatio = dialog.querySelector('#maintainAspectRatio');
            
            widthInput.addEventListener('input', () => {
                if (maintainRatio.checked) {
                    heightInput.value = Math.round(widthInput.value / aspectRatio);
                }
            });
            
            heightInput.addEventListener('input', () => {
                if (maintainRatio.checked) {
                    widthInput.value = Math.round(heightInput.value * aspectRatio);
                }
            });
        }

        function setCanvasSize(width, height) {
            document.getElementById('canvasWidth').value = width;
            document.getElementById('canvasHeight').value = height;
        }

        function setBackgroundColor(color) {
            window.selectedBackgroundColor = color;
            // Visual feedback
            document.querySelectorAll('[onclick*="setBackgroundColor"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            event.target.classList.add('ring-2', 'ring-blue-500');
        }

        function closeCanvasSizeDialog() {
            if (window.currentCanvasSizeDialog) {
                window.currentCanvasSizeDialog.remove();
                window.currentCanvasSizeDialog = null;
            }
        }

        function applyCanvasSize() {
            const width = parseInt(document.getElementById('canvasWidth').value);
            const height = parseInt(document.getElementById('canvasHeight').value);
            const backgroundColor = window.selectedBackgroundColor || document.getElementById('customBackgroundColor').value;
            
            if (width && height && width >= 100 && height >= 100 && width <= 5000 && height <= 5000) {
                // Save current content
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                tempCtx.drawImage(canvas, 0, 0);
                
                // Resize canvas
                canvas.width = width;
                canvas.height = height;
                
                // Apply background
                if (backgroundColor === 'transparent') {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                } else {
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                
                // Restore content (centered)
                const offsetX = (canvas.width - tempCanvas.width) / 2;
                const offsetY = (canvas.height - tempCanvas.height) / 2;
                ctx.drawImage(tempCanvas, Math.max(0, offsetX), Math.max(0, offsetY));
                
                // Update elements positions if needed
                if (offsetX > 0 || offsetY > 0) {
                    elements.forEach(element => {
                        element.x += Math.max(0, offsetX);
                        element.y += Math.max(0, offsetY);
                    });
                }
                
                redrawCanvas();
                updateCanvasInfo();
                updateLayersList();
                addToHistory(`Resize Canvas to ${width}x${height}`);
                saveState();
                showNotification(`ğŸ“ Tela redimensionada para ${width}x${height}px!`);
                closeCanvasSizeDialog();
            } else {
                showNotification('âš ï¸ Tamanho invÃ¡lido! Use valores entre 100 e 5000 pixels.');
            }
        }

        // Layer operations
        function newLayer() {
            const name = prompt('Layer name:', `Layer ${layers.length + 1}`);
            if (name) {
                layers.push({
                    name: name,
                    visible: true,
                    opacity: 100,
                    data: ctx.getImageData(0, 0, canvas.width, canvas.height)
                });
                updateLayersList();
                addToHistory('New Layer');
                showNotification('â• New layer created!');
            }
        }

        function duplicateLayer() {
            const currentLayerData = layers[currentLayer];
            layers.push({
                name: currentLayerData.name + ' copy',
                visible: true,
                opacity: currentLayerData.opacity,
                data: ctx.getImageData(0, 0, canvas.width, canvas.height)
            });
            updateLayersList();
            addToHistory('Duplicate Layer');
            showNotification('ğŸ“‘ Layer duplicated!');
        }

        function deleteLayer() {
            if (layers.length > 1) {
                layers.splice(currentLayer, 1);
                currentLayer = Math.max(0, currentLayer - 1);
                updateLayersList();
                addToHistory('Delete Layer');
                showNotification('ğŸ—‘ï¸ Layer deleted!');
            }
        }

        function updateLayersList() {
            const layersList = document.getElementById('layersList');
            layersList.innerHTML = '';
            
            // Add elements as layers (in reverse order for proper z-index display)
            for (let index = elements.length - 1; index >= 0; index--) {
                const element = elements[index];
                const layerItem = document.createElement('div');
                layerItem.className = `layer-item ${element.selected ? 'active' : ''} relative`;
                layerItem.dataset.element = index;
                layerItem.draggable = true;
                
                const icon = element.type === 'image' ? 'ğŸ–¼ï¸' : element.type === 'text' ? 'ğŸ“' : 'ğŸ”²';
                const name = element.type === 'text' ? `Text: ${element.data.substring(0, 10)}...` : 
                           element.type === 'image' ? `Image ${index + 1}` : `Shape ${index + 1}`;
                
                layerItem.innerHTML = `
                    <div class="layer-thumbnail">${icon}</div>
                    <div class="flex-1">
                        <div class="font-medium">${name}</div>
                        <div class="text-xs text-gray-400">Normal â€¢ ${Math.round(element.opacity * 100)}%</div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="toggleLayerVisibility(${index})" class="text-xs hover:bg-gray-600 px-1 rounded">${element.visible ? 'ğŸ‘ï¸' : 'ğŸš«'}</button>
                        <button onclick="moveLayerUp(${index})" class="text-xs hover:bg-gray-600 px-1 rounded" title="Mover para frente">â¬†ï¸</button>
                        <button onclick="moveLayerDown(${index})" class="text-xs hover:bg-gray-600 px-1 rounded" title="Mover para trÃ¡s">â¬‡ï¸</button>
                    </div>
                `;
                
                layerItem.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') return; // Don't select if clicking buttons
                    
                    // Deselect all elements
                    elements.forEach(el => el.selected = false);
                    // Select clicked element
                    element.selected = true;
                    selectedElement = element;
                    updateLayersList();
                    redrawCanvas();
                });
                
                // Double-click to edit text
                layerItem.addEventListener('dblclick', (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    if (element.type === 'text') {
                        editTextElement(element);
                    }
                });
                
                // Drag and drop functionality
                layerItem.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', index);
                    layerItem.style.opacity = '0.5';
                });
                
                layerItem.addEventListener('dragend', () => {
                    layerItem.style.opacity = '1';
                });
                
                layerItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    layerItem.style.borderTop = '2px solid #0078d4';
                });
                
                layerItem.addEventListener('dragleave', () => {
                    layerItem.style.borderTop = 'none';
                });
                
                layerItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    layerItem.style.borderTop = 'none';
                    
                    const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = index;
                    
                    if (draggedIndex !== targetIndex) {
                        reorderLayers(draggedIndex, targetIndex);
                    }
                });
                
                layersList.appendChild(layerItem);
            }
            
            // Add original layers
            layers.forEach((layer, index) => {
                const layerItem = document.createElement('div');
                layerItem.className = `layer-item ${index === currentLayer && !selectedElement ? 'active' : ''}`;
                layerItem.dataset.layer = index;
                layerItem.innerHTML = `
                    <div class="layer-thumbnail">ğŸ”’</div>
                    <div class="flex-1">
                        <div class="font-medium">${layer.name}</div>
                        <div class="text-xs text-gray-400">Normal â€¢ ${layer.opacity}%</div>
                    </div>
                    <div class="text-xs">${layer.visible ? 'ğŸ‘ï¸' : 'ğŸš«'}</div>
                `;
                
                layerItem.addEventListener('click', () => {
                    currentLayer = index;
                    elements.forEach(el => el.selected = false);
                    selectedElement = null;
                    updateLayersList();
                    redrawCanvas();
                });
                
                layersList.appendChild(layerItem);
            });
        }
        
        // Layer reordering functions
        function moveLayerUp(index) {
            if (index < elements.length - 1) {
                const temp = elements[index];
                elements[index] = elements[index + 1];
                elements[index + 1] = temp;
                updateLayersList();
                redrawCanvas();
                addToHistory('Move Layer Up');
                showNotification('â¬†ï¸ Camada movida para frente!');
            }
        }
        
        function moveLayerDown(index) {
            if (index > 0) {
                const temp = elements[index];
                elements[index] = elements[index - 1];
                elements[index - 1] = temp;
                updateLayersList();
                redrawCanvas();
                addToHistory('Move Layer Down');
                showNotification('â¬‡ï¸ Camada movida para trÃ¡s!');
            }
        }
        
        function toggleLayerVisibility(index) {
            elements[index].visible = !elements[index].visible;
            updateLayersList();
            redrawCanvas();
            addToHistory('Toggle Layer Visibility');
            showNotification(elements[index].visible ? 'ğŸ‘ï¸ Camada visÃ­vel!' : 'ğŸš« Camada oculta!');
        }
        
        function reorderLayers(fromIndex, toIndex) {
            const element = elements.splice(fromIndex, 1)[0];
            elements.splice(toIndex, 0, element);
            updateLayersList();
            redrawCanvas();
            addToHistory('Reorder Layers');
            showNotification('ğŸ”„ Camadas reordenadas!');
        }
        
        // Add text element from menu
        function addTextElement() {
            addTextToCanvas();
        }

        // Quick text addition function
        function addTextToCanvas() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-96">
                    <h3 class="text-white text-lg font-bold mb-4">ğŸ“ Adicionar Texto</h3>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Texto:</label>
                        <textarea id="quickTextContent" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 h-24 resize-none" placeholder="Digite seu texto aqui..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm mb-2">Fonte:</label>
                            <select id="quickFontFamily" class="w-full bg-gray-700 text-white px-2 py-1 text-xs border border-gray-600 rounded">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                                <option value="Impact">Impact</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-2">Tamanho:</label>
                            <input type="number" id="quickFontSize" value="48" min="8" max="200" class="w-full bg-gray-700 text-white px-2 py-1 text-xs border border-gray-600 rounded">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Cor:</label>
                        <div class="flex gap-2 mb-2">
                            <button onclick="setQuickTextColor('#000000')" class="w-8 h-8 bg-black border-2 border-gray-600 rounded" title="Preto"></button>
                            <button onclick="setQuickTextColor('#ffffff')" class="w-8 h-8 bg-white border-2 border-gray-600 rounded" title="Branco"></button>
                            <button onclick="setQuickTextColor('#ff0000')" class="w-8 h-8 bg-red-500 border-2 border-gray-600 rounded" title="Vermelho"></button>
                            <button onclick="setQuickTextColor('#00ff00')" class="w-8 h-8 bg-green-500 border-2 border-gray-600 rounded" title="Verde"></button>
                            <button onclick="setQuickTextColor('#0000ff')" class="w-8 h-8 bg-blue-500 border-2 border-gray-600 rounded" title="Azul"></button>
                            <button onclick="setQuickTextColor('#ffff00')" class="w-8 h-8 bg-yellow-500 border-2 border-gray-600 rounded" title="Amarelo"></button>
                            <input type="color" id="quickTextColor" value="#000000" class="w-8 h-8 border-2 border-gray-600 rounded cursor-pointer" title="Cor personalizada">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Estilo:</label>
                        <div class="flex gap-2">
                            <button id="quickBold" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white font-bold">B</button>
                            <button id="quickItalic" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white italic">I</button>
                            <button id="quickUnderline" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white underline">U</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">PosiÃ§Ã£o:</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setTextPosition('top-left')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†– Superior Esq.</button>
                            <button onclick="setTextPosition('top-center')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†‘ Superior Centro</button>
                            <button onclick="setTextPosition('top-right')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†— Superior Dir.</button>
                            <button onclick="setTextPosition('center-left')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â† Centro Esq.</button>
                            <button onclick="setTextPosition('center')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs bg-blue-600">ğŸ¯ Centro</button>
                            <button onclick="setTextPosition('center-right')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†’ Centro Dir.</button>
                            <button onclick="setTextPosition('bottom-left')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†™ Inferior Esq.</button>
                            <button onclick="setTextPosition('bottom-center')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†“ Inferior Centro</button>
                            <button onclick="setTextPosition('bottom-right')" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white text-xs">â†˜ Inferior Dir.</button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end">
                        <button onclick="closeQuickTextDialog()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Cancelar</button>
                        <button onclick="createQuickText()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">Adicionar Texto</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentQuickTextDialog = dialog;
            window.selectedTextPosition = 'center';
            window.selectedQuickTextColor = '#000000';
            
            // Style buttons functionality
            dialog.querySelector('#quickBold').addEventListener('click', function() {
                this.classList.toggle('bg-blue-600');
            });
            dialog.querySelector('#quickItalic').addEventListener('click', function() {
                this.classList.toggle('bg-blue-600');
            });
            dialog.querySelector('#quickUnderline').addEventListener('click', function() {
                this.classList.toggle('bg-blue-600');
            });
        }

        function setQuickTextColor(color) {
            window.selectedQuickTextColor = color;
            document.getElementById('quickTextColor').value = color;
            // Visual feedback
            document.querySelectorAll('[onclick*="setQuickTextColor"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            event.target.classList.add('ring-2', 'ring-blue-500');
        }

        function setTextPosition(position) {
            window.selectedTextPosition = position;
            // Visual feedback
            document.querySelectorAll('[onclick*="setTextPosition"]').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.classList.remove('bg-gray-700');
            event.target.classList.add('bg-blue-600');
        }

        function closeQuickTextDialog() {
            if (window.currentQuickTextDialog) {
                window.currentQuickTextDialog.remove();
                window.currentQuickTextDialog = null;
            }
        }

        function createQuickText() {
            const text = document.getElementById('quickTextContent').value.trim();
            if (!text) {
                showNotification('âš ï¸ Digite algum texto primeiro!');
                return;
            }

            const fontSize = parseInt(document.getElementById('quickFontSize').value);
            const fontFamily = document.getElementById('quickFontFamily').value;
            const color = window.selectedQuickTextColor || document.getElementById('quickTextColor').value;
            const position = window.selectedTextPosition || 'center';
            
            const dialog = window.currentQuickTextDialog;
            const isBold = dialog.querySelector('#quickBold').classList.contains('bg-blue-600');
            const isItalic = dialog.querySelector('#quickItalic').classList.contains('bg-blue-600');
            const isUnderline = dialog.querySelector('#quickUnderline').classList.contains('bg-blue-600');

            // Calculate text dimensions
            ctx.font = `${isBold ? 'bold ' : ''}${isItalic ? 'italic ' : ''}${fontSize}px ${fontFamily}`;
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            const textHeight = fontSize;

            // Calculate position based on selection
            let x, y;
            const margin = 50;
            
            switch(position) {
                case 'top-left':
                    x = margin;
                    y = margin;
                    break;
                case 'top-center':
                    x = (canvas.width - textWidth) / 2;
                    y = margin;
                    break;
                case 'top-right':
                    x = canvas.width - textWidth - margin;
                    y = margin;
                    break;
                case 'center-left':
                    x = margin;
                    y = (canvas.height - textHeight) / 2;
                    break;
                case 'center':
                    x = (canvas.width - textWidth) / 2;
                    y = (canvas.height - textHeight) / 2;
                    break;
                case 'center-right':
                    x = canvas.width - textWidth - margin;
                    y = (canvas.height - textHeight) / 2;
                    break;
                case 'bottom-left':
                    x = margin;
                    y = canvas.height - textHeight - margin;
                    break;
                case 'bottom-center':
                    x = (canvas.width - textWidth) / 2;
                    y = canvas.height - textHeight - margin;
                    break;
                case 'bottom-right':
                    x = canvas.width - textWidth - margin;
                    y = canvas.height - textHeight - margin;
                    break;
                default:
                    x = (canvas.width - textWidth) / 2;
                    y = (canvas.height - textHeight) / 2;
            }

            // Create text element
            const textElement = new Element('text', Math.max(0, x), Math.max(0, y), textWidth, textHeight);
            textElement.data = text;
            textElement.style = {
                fontSize: fontSize,
                fontFamily: fontFamily,
                color: color,
                fontWeight: isBold ? 'bold' : 'normal',
                fontStyle: isItalic ? 'italic' : 'normal',
                textDecoration: isUnderline ? 'underline' : 'none'
            };

            elements.push(textElement);

            // Select the new text element
            elements.forEach(el => el.selected = false);
            textElement.selected = true;
            selectedElement = textElement;

            redrawCanvas();
            updateLayersList();
            addToHistory('Add Text');
            saveState();
            showNotification('ğŸ“ Texto adicionado! Clique duas vezes para editar ou use a ferramenta Move para mover.');
            closeQuickTextDialog();
        }

        // Adjustments
        function applyAdjustments() {
            if (!originalImageData) {
                originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const saturation = document.getElementById('saturation').value;
            
            document.getElementById('brightnessValue').textContent = brightness;
            document.getElementById('contrastValue').textContent = contrast;
            document.getElementById('saturationValue').textContent = saturation;
            
            const imageData = ctx.createImageData(originalImageData);
            const data = imageData.data;
            const originalData = originalImageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Brightness
                data[i] = Math.max(0, Math.min(255, originalData[i] + brightness * 2.55));
                data[i + 1] = Math.max(0, Math.min(255, originalData[i + 1] + brightness * 2.55));
                data[i + 2] = Math.max(0, Math.min(255, originalData[i + 2] + brightness * 2.55));
                
                // Contrast
                const contrastFactor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                data[i] = Math.max(0, Math.min(255, contrastFactor * (data[i] - 128) + 128));
                data[i + 1] = Math.max(0, Math.min(255, contrastFactor * (data[i + 1] - 128) + 128));
                data[i + 2] = Math.max(0, Math.min(255, contrastFactor * (data[i + 2] - 128) + 128));
                
                data[i + 3] = originalData[i + 3]; // Alpha
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // Filters
        function applyFilter(filterType) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(filterType) {
                case 'blur':
                    ctx.filter = 'blur(2px)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'sharpen':
                    // Sharpen filter implementation
                    applyConvolution(data, canvas.width, canvas.height, [
                        0, -1, 0,
                        -1, 5, -1,
                        0, -1, 0
                    ]);
                    ctx.putImageData(imageData, 0, 0);
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                        data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                        data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.2);
                        data[i + 1] = Math.min(255, data[i + 1] * 1.1);
                        data[i + 2] = Math.min(255, data[i + 2] * 0.8);
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
            }
            
            addToHistory(`Apply ${filterType} filter`);
            showNotification(`ğŸ¨ ${filterType} filter applied!`);
        }

        function applyConvolution(data, width, height, kernel) {
            const side = Math.round(Math.sqrt(kernel.length));
            const halfSide = Math.floor(side / 2);
            const output = new Uint8ClampedArray(data.length);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let r = 0, g = 0, b = 0;
                    
                    for (let cy = 0; cy < side; cy++) {
                        for (let cx = 0; cx < side; cx++) {
                            const scy = y + cy - halfSide;
                            const scx = x + cx - halfSide;
                            
                            if (scy >= 0 && scy < height && scx >= 0 && scx < width) {
                                const srcOff = (scy * width + scx) * 4;
                                const wt = kernel[cy * side + cx];
                                r += data[srcOff] * wt;
                                g += data[srcOff + 1] * wt;
                                b += data[srcOff + 2] * wt;
                            }
                        }
                    }
                    
                    const dstOff = (y * width + x) * 4;
                    output[dstOff] = r;
                    output[dstOff + 1] = g;
                    output[dstOff + 2] = b;
                    output[dstOff + 3] = data[dstOff + 3];
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = output[i];
            }
        }

        // Remove background (simplified)
        function removeBackground() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Simple background removal based on corner color
            const cornerColor = [data[0], data[1], data[2]];
            const tolerance = 50;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                const diff = Math.abs(r - cornerColor[0]) + Math.abs(g - cornerColor[1]) + Math.abs(b - cornerColor[2]);
                
                if (diff < tolerance) {
                    data[i + 3] = 0; // Make transparent
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            addToHistory('Remove Background');
            showNotification('âœ‚ï¸ Background removed!');
        }

        // History and undo/redo
        function saveState() {
            historyStep++;
            if (historyStep < history.length) {
                history.length = historyStep;
            }
            history.push(canvas.toDataURL());
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                restoreState();
                showNotification('â†¶ Undo');
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                restoreState();
                showNotification('â†· Redo');
            }
        }

        function restoreState() {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = history[historyStep];
        }

        function addToHistory(action) {
            const historyList = document.getElementById('historyList');
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.textContent = action;
            historyList.appendChild(historyItem);
            historyList.scrollTop = historyList.scrollHeight;
        }

        // Utility functions
        function updateCanvasInfo() {
            document.getElementById('canvasInfo').textContent = `${canvas.width} x ${canvas.height} px â€¢ RGB/8`;
        }

        function updateStatusBar() {
            const toolNames = {
                move: 'Move Tool',
                'quick-select': 'SeleÃ§Ã£o RÃ¡pida',
                lasso: 'Lasso Tool',
                'object-select': 'Selecionar Objeto',
                crop: 'Crop Tool',
                brush: 'Brush Tool',
                eraser: 'Eraser Tool',
                clone: 'Clone Stamp',
                healing: 'Healing Brush',
                text: 'Text Tool',
                shape: 'Shape Tool',
                gradient: 'Gradient Tool',
                bucket: 'Paint Bucket',
                zoom: 'Zoom Tool'
            };
            document.getElementById('toolInfo').textContent = toolNames[currentTool] || currentTool;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleDropdown(menuId, event) {
            event.stopPropagation();
            const menu = document.getElementById(menuId);
            const rect = event.target.getBoundingClientRect();
            
            // Hide all other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m.id !== menuId) m.classList.add('hidden');
            });
            
            menu.classList.toggle('hidden');
            menu.style.left = rect.left + 'px';
            menu.style.top = rect.bottom + 'px';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
        });

        // Brush size and opacity updates
        document.getElementById('brushSize').addEventListener('input', function() {
            document.getElementById('brushSizeValue').textContent = this.value + 'px';
        });

        document.getElementById('brushOpacity').addEventListener('input', function() {
            document.getElementById('brushOpacityValue').textContent = this.value + '%';
        });

        // Color picker functionality
        document.getElementById('foregroundColor').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'color';
            input.value = '#000000';
            input.addEventListener('change', (e) => {
                this.style.background = e.target.value;
            });
            input.click();
        });

        document.getElementById('backgroundColor').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'color';
            input.value = '#ffffff';
            input.addEventListener('change', (e) => {
                this.style.background = e.target.value;
            });
            input.click();
        });

        // Missing function definitions
        function copy() {
            if (selectedElement) {
                window.copiedElement = JSON.parse(JSON.stringify(selectedElement));
                showNotification('ğŸ“‹ Elemento copiado!');
            }
        }
        
        function paste() {
            if (window.copiedElement) {
                const newElement = JSON.parse(JSON.stringify(window.copiedElement));
                newElement.id = ++elementCounter;
                newElement.x += 20;
                newElement.y += 20;
                elements.push(newElement);
                redrawCanvas();
                updateLayersList();
                showNotification('ğŸ“„ Elemento colado!');
            }
        }
        
        function transform() {
            if (selectedElement) {
                showNotification('ğŸ”„ Modo de transformaÃ§Ã£o ativado!');
            }
        }
        
        function adjustBrightness() {
            showAdjustmentsPanel();
        }
        
        function adjustLevels() {
            showAdjustmentsPanel();
        }
        
        function adjustCurves() {
            showAdjustmentsPanel();
        }
        
        function adjustHueSat() {
            showAdjustmentsPanel();
        }
        
        function addMask() {
            if (selectedElement) {
                showNotification('ğŸ­ MÃ¡scara adicionada!');
            }
        }
        
        function applyBlur() {
            applyFilter('blur');
        }
        
        function applySharpen() {
            applyFilter('sharpen');
        }
        
        function applyNoise() {
            showNotification('ğŸ“º Filtro de ruÃ­do aplicado!');
        }
        
        function applyDistort() {
            showNotification('ğŸŒ€ Filtro de distorÃ§Ã£o aplicado!');
        }
        
        function updateOpacity(value) {
            const opacityElement = document.getElementById('opacityValue');
            if (opacityElement) {
                opacityElement.textContent = value + '%';
            }
            if (selectedElement) {
                selectedElement.opacity = value / 100;
                redrawCanvas();
            }
        }
        
        function updateBlendMode(mode) {
            showNotification(`Blend mode changed to ${mode}!`);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Control') {
                isCtrlPressed = true;
            }
            
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'z': e.preventDefault(); undo(); break;
                    case 'y': e.preventDefault(); redo(); break;
                    case 's': e.preventDefault(); saveFile(); break;
                    case 'o': e.preventDefault(); openFile(); break;
                    case 'n': e.preventDefault(); newDocument(); break;
                    case 'e': e.preventDefault(); groupSelectedElements(); break;
                }
            }
            
            // Tool shortcuts
            switch(e.key.toLowerCase()) {
                case 'v': selectTool('move'); break;
                case 'm': selectTool('marquee'); break;
                case 'l': selectTool('lasso'); break;
                case 'w': selectTool('selection'); break;
                case 'c': selectTool('crop'); break;
                case 'i': selectTool('eyedropper'); break;
                case 'j': selectTool('healing'); break;
                case 'b': selectTool('brush'); break;
                case 's': if (!e.ctrlKey) selectTool('clone'); break;
                case 'y': selectTool('history'); break;
                case 'e': selectTool('eraser'); break;
                case 'g': selectTool('fill'); break;
                case 'r': selectTool('focus'); break;
                case 'o': selectTool('toning'); break;
                case 't': selectTool('text'); break;
                case 'p': selectTool('path'); break;
                case 'u': selectTool('shape'); break;
                case 'h': selectTool('navigation'); break;
                case 'z': if (!e.ctrlKey) selectTool('navigation', 'zoom'); break;
            }
        });
        
        document.addEventListener('keyup', function(e) {
            if (e.key === 'Control') {
                isCtrlPressed = false;
            }
        });

        function selectTool(tool, subtool = null) {
            document.querySelectorAll('.tool-button').forEach(b => b.classList.remove('active'));
            const toolButton = document.querySelector(`[data-tool="${tool}"]`);
            if (toolButton) {
                toolButton.classList.add('active');
                currentTool = tool;
                currentSubtool = subtool || 'default';
                updateToolOptions();
                updateStatusBar();
            }
        }

        // Smart panel functionality
        document.getElementById('selectObjectBtn').addEventListener('click', () => {
            showNotification('ğŸ§² Detectando objetos na imagem...');
            setTimeout(() => {
                showNotification('âœ… Objeto selecionado automaticamente!');
                addToHistory('Select Object');
            }, 1500);
        });

        document.getElementById('removeBackgroundBtn').addEventListener('click', () => {
            removeBackground();
        });

        document.getElementById('autoColorBtn').addEventListener('click', () => {
            showNotification('ğŸ¨ Aplicando correÃ§Ã£o automÃ¡tica de cores...');
            setTimeout(() => {
                // Auto adjust brightness and contrast
                document.getElementById('brightness').value = 10;
                document.getElementById('contrast').value = 15;
                applyAdjustments();
                showNotification('âœ… Cores ajustadas automaticamente!');
                addToHistory('Auto Color Correction');
            }, 1000);
        });

        document.getElementById('autoEnhanceBtn').addEventListener('click', () => {
            showNotification('âœ¨ Melhorando qualidade da imagem...');
            setTimeout(() => {
                applyFilter('sharpen');
                showNotification('âœ… Imagem melhorada!');
            }, 1200);
        });

        // Layer effects and mask functions
        function addLayerEffect() {
            if (!selectedElement) {
                showNotification('âš ï¸ Selecione uma camada primeiro!');
                return;
            }
            
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-96 max-h-96 overflow-y-auto">
                    <h3 class="text-white text-lg font-bold mb-4">fx Efeitos de Camada</h3>
                    
                    <!-- Drop Shadow -->
                    <div class="mb-4 border-b border-gray-600 pb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="enableDropShadow" class="w-4 h-4">
                            <label class="text-white font-medium">ğŸŒ‘ Sombra Projetada</label>
                        </div>
                        <div id="dropShadowControls" class="ml-6 space-y-2 hidden">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-white text-xs mb-1">DistÃ¢ncia:</label>
                                    <input type="range" id="shadowDistance" min="0" max="50" value="5" class="w-full">
                                    <span id="shadowDistanceValue" class="text-xs text-gray-400">5px</span>
                                </div>
                                <div>
                                    <label class="block text-white text-xs mb-1">Desfoque:</label>
                                    <input type="range" id="shadowBlur" min="0" max="50" value="10" class="w-full">
                                    <span id="shadowBlurValue" class="text-xs text-gray-400">10px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Cor da Sombra:</label>
                                <input type="color" id="shadowColor" value="#000000" class="w-full h-8 rounded">
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Opacidade:</label>
                                <input type="range" id="shadowOpacity" min="0" max="100" value="75" class="w-full">
                                <span id="shadowOpacityValue" class="text-xs text-gray-400">75%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outer Glow -->
                    <div class="mb-4 border-b border-gray-600 pb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="enableOuterGlow" class="w-4 h-4">
                            <label class="text-white font-medium">âœ¨ Brilho Externo</label>
                        </div>
                        <div id="outerGlowControls" class="ml-6 space-y-2 hidden">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-white text-xs mb-1">Tamanho:</label>
                                    <input type="range" id="glowSize" min="0" max="50" value="15" class="w-full">
                                    <span id="glowSizeValue" class="text-xs text-gray-400">15px</span>
                                </div>
                                <div>
                                    <label class="block text-white text-xs mb-1">Intensidade:</label>
                                    <input type="range" id="glowIntensity" min="0" max="100" value="50" class="w-full">
                                    <span id="glowIntensityValue" class="text-xs text-gray-400">50%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Cor do Brilho:</label>
                                <input type="color" id="glowColor" value="#ffffff" class="w-full h-8 rounded">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bevel and Emboss -->
                    <div class="mb-4 border-b border-gray-600 pb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="enableBevel" class="w-4 h-4">
                            <label class="text-white font-medium">ğŸ”³ Chanfro e Entalhe</label>
                        </div>
                        <div id="bevelControls" class="ml-6 space-y-2 hidden">
                            <div>
                                <label class="block text-white text-xs mb-1">Profundidade:</label>
                                <input type="range" id="bevelDepth" min="1" max="20" value="5" class="w-full">
                                <span id="bevelDepthValue" class="text-xs text-gray-400">5px</span>
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Tamanho:</label>
                                <input type="range" id="bevelSize" min="1" max="30" value="10" class="w-full">
                                <span id="bevelSizeValue" class="text-xs text-gray-400">10px</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stroke -->
                    <div class="mb-4 border-b border-gray-600 pb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="enableStroke" class="w-4 h-4">
                            <label class="text-white font-medium">ğŸ–Šï¸ TraÃ§ado</label>
                        </div>
                        <div id="strokeControls" class="ml-6 space-y-2 hidden">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-white text-xs mb-1">Tamanho:</label>
                                    <input type="range" id="strokeSize" min="1" max="20" value="3" class="w-full">
                                    <span id="strokeSizeValue" class="text-xs text-gray-400">3px</span>
                                </div>
                                <div>
                                    <label class="block text-white text-xs mb-1">PosiÃ§Ã£o:</label>
                                    <select id="strokePosition" class="w-full bg-gray-700 text-white px-2 py-1 text-xs rounded">
                                        <option value="outside">Externo</option>
                                        <option value="inside">Interno</option>
                                        <option value="center">Centro</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Cor do TraÃ§ado:</label>
                                <input type="color" id="strokeColor" value="#000000" class="w-full h-8 rounded">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Color Overlay -->
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="enableColorOverlay" class="w-4 h-4">
                            <label class="text-white font-medium">ğŸ¨ SobreposiÃ§Ã£o de Cor</label>
                        </div>
                        <div id="colorOverlayControls" class="ml-6 space-y-2 hidden">
                            <div>
                                <label class="block text-white text-xs mb-1">Cor:</label>
                                <input type="color" id="overlayColor" value="#ff0000" class="w-full h-8 rounded">
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Modo de Mesclagem:</label>
                                <select id="overlayBlendMode" class="w-full bg-gray-700 text-white px-2 py-1 text-xs rounded">
                                    <option value="normal">Normal</option>
                                    <option value="multiply">Multiplicar</option>
                                    <option value="screen">Clarear</option>
                                    <option value="overlay">Sobrepor</option>
                                    <option value="soft-light">Luz Suave</option>
                                    <option value="hard-light">Luz Forte</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-white text-xs mb-1">Opacidade:</label>
                                <input type="range" id="overlayOpacity" min="0" max="100" value="50" class="w-full">
                                <span id="overlayOpacityValue" class="text-xs text-gray-400">50%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end mt-6">
                        <button onclick="closeLayerEffects()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Cancelar</button>
                        <button onclick="applyLayerEffects()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Aplicar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentLayerEffects = dialog;
            
            // Setup event listeners for controls
            setupLayerEffectControls(dialog);
        }
        
        function setupLayerEffectControls(dialog) {
            // Toggle controls visibility
            const toggles = ['enableDropShadow', 'enableOuterGlow', 'enableBevel', 'enableStroke', 'enableColorOverlay'];
            const controls = ['dropShadowControls', 'outerGlowControls', 'bevelControls', 'strokeControls', 'colorOverlayControls'];
            
            toggles.forEach((toggleId, index) => {
                const toggle = dialog.querySelector(`#${toggleId}`);
                const control = dialog.querySelector(`#${controls[index]}`);
                
                toggle.addEventListener('change', () => {
                    control.classList.toggle('hidden', !toggle.checked);
                });
            });
            
            // Value display updates
            const sliders = [
                { id: 'shadowDistance', valueId: 'shadowDistanceValue', suffix: 'px' },
                { id: 'shadowBlur', valueId: 'shadowBlurValue', suffix: 'px' },
                { id: 'shadowOpacity', valueId: 'shadowOpacityValue', suffix: '%' },
                { id: 'glowSize', valueId: 'glowSizeValue', suffix: 'px' },
                { id: 'glowIntensity', valueId: 'glowIntensityValue', suffix: '%' },
                { id: 'bevelDepth', valueId: 'bevelDepthValue', suffix: 'px' },
                { id: 'bevelSize', valueId: 'bevelSizeValue', suffix: 'px' },
                { id: 'strokeSize', valueId: 'strokeSizeValue', suffix: 'px' },
                { id: 'overlayOpacity', valueId: 'overlayOpacityValue', suffix: '%' }
            ];
            
            sliders.forEach(slider => {
                const element = dialog.querySelector(`#${slider.id}`);
                const valueElement = dialog.querySelector(`#${slider.valueId}`);
                
                element.addEventListener('input', () => {
                    valueElement.textContent = element.value + slider.suffix;
                });
            });
        }
        
        function closeLayerEffects() {
            if (window.currentLayerEffects) {
                window.currentLayerEffects.remove();
                window.currentLayerEffects = null;
            }
        }
        
        function applyLayerEffects() {
            if (!selectedElement || !window.currentLayerEffects) return;
            
            const dialog = window.currentLayerEffects;
            
            // Initialize effects object
            if (!selectedElement.effects) {
                selectedElement.effects = {};
            }
            
            // Drop Shadow
            if (dialog.querySelector('#enableDropShadow').checked) {
                selectedElement.effects.dropShadow = {
                    distance: parseInt(dialog.querySelector('#shadowDistance').value),
                    blur: parseInt(dialog.querySelector('#shadowBlur').value),
                    color: dialog.querySelector('#shadowColor').value,
                    opacity: parseInt(dialog.querySelector('#shadowOpacity').value) / 100
                };
            } else {
                delete selectedElement.effects.dropShadow;
            }
            
            // Outer Glow
            if (dialog.querySelector('#enableOuterGlow').checked) {
                selectedElement.effects.outerGlow = {
                    size: parseInt(dialog.querySelector('#glowSize').value),
                    intensity: parseInt(dialog.querySelector('#glowIntensity').value) / 100,
                    color: dialog.querySelector('#glowColor').value
                };
            } else {
                delete selectedElement.effects.outerGlow;
            }
            
            // Stroke
            if (dialog.querySelector('#enableStroke').checked) {
                selectedElement.effects.stroke = {
                    size: parseInt(dialog.querySelector('#strokeSize').value),
                    color: dialog.querySelector('#strokeColor').value,
                    position: dialog.querySelector('#strokePosition').value
                };
            } else {
                delete selectedElement.effects.stroke;
            }
            
            // Color Overlay
            if (dialog.querySelector('#enableColorOverlay').checked) {
                selectedElement.effects.colorOverlay = {
                    color: dialog.querySelector('#overlayColor').value,
                    blendMode: dialog.querySelector('#overlayBlendMode').value,
                    opacity: parseInt(dialog.querySelector('#overlayOpacity').value) / 100
                };
            } else {
                delete selectedElement.effects.colorOverlay;
            }
            
            redrawCanvas();
            updateLayersList();
            addToHistory('Apply Layer Effects');
            showNotification('fx Efeitos aplicados Ã  camada!');
            closeLayerEffects();
        }

        function addLayerMask() {
            showNotification('ğŸ”˜ MÃ¡scara de camada criada!');
            addToHistory('Add Layer Mask');
        }

        // Move Tool functionality
        let selectedLayers = [];
        let transformControls = null;

        // Auto-select functionality
        canvas.addEventListener('click', function(e) {
            if (currentTool === 'move' && document.getElementById('autoSelect').checked) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Simulate layer detection (in real Photoshop this would check actual layer content)
                const clickedLayer = detectLayerAtPoint(x, y);
                if (clickedLayer !== -1) {
                    selectLayer(clickedLayer);
                    showNotification(`ğŸ¯ Camada "${layers[clickedLayer].name}" selecionada automaticamente!`);
                }
            }
        });

        function detectLayerAtPoint(x, y) {
            // Simplified layer detection - in real implementation this would check pixel data
            const imageData = ctx.getImageData(x, y, 1, 1);
            const alpha = imageData.data[3];
            
            if (alpha > 0) {
                return currentLayer; // Return current layer if there's content
            }
            return -1;
        }

        function selectLayer(layerIndex) {
            currentLayer = layerIndex;
            updateLayersList();
            
            if (document.getElementById('showTransformControls').checked) {
                showTransformControls();
            }
        }

        function showTransformControls() {
            // Create visual transform controls around selected content
            const canvasRect = canvas.getBoundingClientRect();
            
            if (transformControls) {
                transformControls.remove();
            }
            
            transformControls = document.createElement('div');
            transformControls.className = 'absolute border-2 border-blue-500 pointer-events-none';
            transformControls.style.left = (canvasRect.left + 50) + 'px';
            transformControls.style.top = (canvasRect.top + 50) + 'px';
            transformControls.style.width = '200px';
            transformControls.style.height = '150px';
            transformControls.innerHTML = `
                <div class="absolute -top-1 -left-1 w-2 h-2 bg-blue-500 cursor-nw-resize"></div>
                <div class="absolute -top-1 left-1/2 w-2 h-2 bg-blue-500 cursor-n-resize"></div>
                <div class="absolute -top-1 -right-1 w-2 h-2 bg-blue-500 cursor-ne-resize"></div>
                <div class="absolute top-1/2 -right-1 w-2 h-2 bg-blue-500 cursor-e-resize"></div>
                <div class="absolute -bottom-1 -right-1 w-2 h-2 bg-blue-500 cursor-se-resize"></div>
                <div class="absolute -bottom-1 left-1/2 w-2 h-2 bg-blue-500 cursor-s-resize"></div>
                <div class="absolute -bottom-1 -left-1 w-2 h-2 bg-blue-500 cursor-sw-resize"></div>
                <div class="absolute top-1/2 -left-1 w-2 h-2 bg-blue-500 cursor-w-resize"></div>
            `;
            
            document.body.appendChild(transformControls);
        }

        // Alignment functions
        document.getElementById('alignTop').addEventListener('click', () => alignLayers('top'));
        document.getElementById('alignVCenter').addEventListener('click', () => alignLayers('vcenter'));
        document.getElementById('alignBottom').addEventListener('click', () => alignLayers('bottom'));
        document.getElementById('alignLeft').addEventListener('click', () => alignLayers('left'));
        document.getElementById('alignHCenter').addEventListener('click', () => alignLayers('hcenter'));
        document.getElementById('alignRight').addEventListener('click', () => alignLayers('right'));

        function alignLayers(alignment) {
            if (selectedLayers.length < 2) {
                showNotification('âš ï¸ Selecione pelo menos 2 camadas para alinhar!');
                return;
            }
            
            showNotification(`âœ… Camadas alinhadas: ${alignment}!`);
            addToHistory(`Align ${alignment}`);
        }

        // Distribution functions
        document.getElementById('distributeH').addEventListener('click', () => distributeLayers('horizontal'));
        document.getElementById('distributeV').addEventListener('click', () => distributeLayers('vertical'));

        function distributeLayers(direction) {
            if (selectedLayers.length < 3) {
                showNotification('âš ï¸ Selecione pelo menos 3 camadas para distribuir!');
                return;
            }
            
            showNotification(`âœ… Camadas distribuÃ­das ${direction === 'horizontal' ? 'horizontalmente' : 'verticalmente'}!`);
            addToHistory(`Distribute ${direction}`);
        }

        // More options and settings
        document.getElementById('moreOptions').addEventListener('click', () => {
            showNotification('ğŸ“‹ OpÃ§Ãµes adicionais da ferramenta Move!');
        });

        document.getElementById('toolSettings').addEventListener('click', () => {
            showToolSettingsDialog();
        });

        function showToolSettingsDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-80">
                    <h3 class="text-white text-lg font-bold mb-4">âš™ï¸ ConfiguraÃ§Ãµes da Ferramenta Move</h3>
                    
                    <div class="mb-4">
                        <label class="flex items-center gap-2 text-white text-sm">
                            <input type="checkbox" id="showLayerBounds" class="w-4 h-4">
                            Mostrar limites da camada
                        </label>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center gap-2 text-white text-sm">
                            <input type="checkbox" id="snapToGrid" class="w-4 h-4">
                            Ajustar Ã  grade
                        </label>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center gap-2 text-white text-sm">
                            <input type="checkbox" id="snapToGuides" class="w-4 h-4">
                            Ajustar Ã s guias
                        </label>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm mb-2">Sensibilidade do movimento:</label>
                        <input type="range" id="moveSensitivity" min="1" max="10" value="5" class="w-full">
                    </div>
                    
                    <div class="flex gap-2 justify-end">
                        <button onclick="closeToolSettings()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Fechar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentToolSettings = dialog;
        }

        function closeToolSettings() {
            if (window.currentToolSettings) {
                window.currentToolSettings.remove();
                window.currentToolSettings = null;
            }
        }

        // Transform controls toggle
        document.getElementById('showTransformControls').addEventListener('change', function() {
            if (this.checked && currentTool === 'move') {
                showTransformControls();
            } else if (transformControls) {
                transformControls.remove();
                transformControls = null;
            }
        });

        // Brush system
        let currentBrushType = 'round';
        let brushSettings = {
            size: 10,
            opacity: 100,
            hardness: 100,
            spacing: 25,
            angle: 0,
            roundness: 100
        };
        
        function showBrushPicker() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-96 max-h-96 overflow-y-auto">
                    <h3 class="text-white text-lg font-bold mb-4">ğŸ–Œï¸ Seletor de PincÃ©is</h3>
                    
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="round" title="Redondo">
                            <div class="w-8 h-8 bg-white rounded-full mx-auto mb-1"></div>
                            <span class="text-xs text-white">Redondo</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="square" title="Quadrado">
                            <div class="w-8 h-8 bg-white mx-auto mb-1"></div>
                            <span class="text-xs text-white">Quadrado</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="soft-round" title="Redondo Suave">
                            <div class="w-8 h-8 bg-gradient-radial from-white to-transparent rounded-full mx-auto mb-1"></div>
                            <span class="text-xs text-white">Suave</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="texture" title="Texturizado">
                            <div class="w-8 h-8 bg-white mx-auto mb-1" style="background-image: radial-gradient(circle at 2px 2px, transparent 1px, white 1px); background-size: 4px 4px;"></div>
                            <span class="text-xs text-white">Textura</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="watercolor" title="Aquarela">
                            <div class="w-8 h-8 bg-gradient-radial from-blue-300 via-blue-200 to-transparent rounded-full mx-auto mb-1 opacity-70"></div>
                            <span class="text-xs text-white">Aquarela</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="oil" title="Ã“leo">
                            <div class="w-8 h-8 bg-gradient-to-br from-yellow-600 to-red-600 rounded mx-auto mb-1"></div>
                            <span class="text-xs text-white">Ã“leo</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="chalk" title="Giz">
                            <div class="w-8 h-8 bg-white mx-auto mb-1 opacity-80" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 1px, rgba(0,0,0,0.1) 1px, rgba(0,0,0,0.1) 2px);"></div>
                            <span class="text-xs text-white">Giz</span>
                        </button>
                        <button class="brush-preset bg-gray-700 hover:bg-gray-600 p-3 rounded text-center" data-brush="airbrush" title="AerÃ³grafo">
                            <div class="w-8 h-8 bg-gradient-radial from-white via-gray-300 to-transparent rounded-full mx-auto mb-1"></div>
                            <span class="text-xs text-white">AerÃ³grafo</span>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white text-sm mb-2">Tamanho: <span id="brushSizeDisplay">${brushSettings.size}px</span></label>
                            <input type="range" id="brushSizeSlider" min="1" max="200" value="${brushSettings.size}" class="w-full">
                        </div>
                        
                        <div>
                            <label class="block text-white text-sm mb-2">Opacidade: <span id="brushOpacityDisplay">${brushSettings.opacity}%</span></label>
                            <input type="range" id="brushOpacitySlider" min="1" max="100" value="${brushSettings.opacity}" class="w-full">
                        </div>
                        
                        <div>
                            <label class="block text-white text-sm mb-2">Dureza: <span id="brushHardnessDisplay">${brushSettings.hardness}%</span></label>
                            <input type="range" id="brushHardnessSlider" min="0" max="100" value="${brushSettings.hardness}" class="w-full">
                        </div>
                        
                        <div>
                            <label class="block text-white text-sm mb-2">EspaÃ§amento: <span id="brushSpacingDisplay">${brushSettings.spacing}%</span></label>
                            <input type="range" id="brushSpacingSlider" min="1" max="200" value="${brushSettings.spacing}" class="w-full">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white text-sm mb-2">Ã‚ngulo: <span id="brushAngleDisplay">${brushSettings.angle}Â°</span></label>
                                <input type="range" id="brushAngleSlider" min="0" max="360" value="${brushSettings.angle}" class="w-full">
                            </div>
                            <div>
                                <label class="block text-white text-sm mb-2">Redondeza: <span id="brushRoundnessDisplay">${brushSettings.roundness}%</span></label>
                                <input type="range" id="brushRoundnessSlider" min="1" max="100" value="${brushSettings.roundness}" class="w-full">
                            </div>
                        </div>
                        
                        <!-- Brush Preview -->
                        <div class="text-center">
                            <div class="bg-white rounded p-4 inline-block">
                                <canvas id="brushPreview" width="100" height="100" class="border border-gray-300"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end mt-6">
                        <button onclick="closeBrushPicker()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Fechar</button>
                        <button onclick="saveBrushSettings()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Aplicar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentBrushPicker = dialog;
            
            // Setup brush picker events
            setupBrushPickerEvents(dialog);
            updateBrushPreview();
        }
        
        function setupBrushPickerEvents(dialog) {
            // Brush preset selection
            dialog.querySelectorAll('.brush-preset').forEach(preset => {
                preset.addEventListener('click', () => {
                    dialog.querySelectorAll('.brush-preset').forEach(p => p.classList.remove('bg-blue-600'));
                    preset.classList.add('bg-blue-600');
                    currentBrushType = preset.dataset.brush;
                    updateBrushPreview();
                });
            });
            
            // Slider updates
            const sliders = [
                { id: 'brushSizeSlider', displayId: 'brushSizeDisplay', property: 'size', suffix: 'px' },
                { id: 'brushOpacitySlider', displayId: 'brushOpacityDisplay', property: 'opacity', suffix: '%' },
                { id: 'brushHardnessSlider', displayId: 'brushHardnessDisplay', property: 'hardness', suffix: '%' },
                { id: 'brushSpacingSlider', displayId: 'brushSpacingDisplay', property: 'spacing', suffix: '%' },
                { id: 'brushAngleSlider', displayId: 'brushAngleDisplay', property: 'angle', suffix: 'Â°' },
                { id: 'brushRoundnessSlider', displayId: 'brushRoundnessDisplay', property: 'roundness', suffix: '%' }
            ];
            
            sliders.forEach(slider => {
                const element = dialog.querySelector(`#${slider.id}`);
                const display = dialog.querySelector(`#${slider.displayId}`);
                
                element.addEventListener('input', () => {
                    brushSettings[slider.property] = parseInt(element.value);
                    display.textContent = element.value + slider.suffix;
                    updateBrushPreview();
                });
            });
        }
        
        function updateBrushPreview() {
            const preview = document.getElementById('brushPreview');
            if (!preview) return;
            
            const previewCtx = preview.getContext('2d');
            previewCtx.clearRect(0, 0, 100, 100);
            
            const centerX = 50;
            const centerY = 50;
            const size = Math.min(brushSettings.size, 40);
            
            previewCtx.save();
            previewCtx.translate(centerX, centerY);
            previewCtx.rotate((brushSettings.angle * Math.PI) / 180);
            
            switch(currentBrushType) {
                case 'round':
                case 'hard-round':
                    previewCtx.beginPath();
                    previewCtx.arc(0, 0, size / 2, 0, Math.PI * 2);
                    previewCtx.fillStyle = '#000000';
                    previewCtx.fill();
                    break;
                    
                case 'soft-round':
                    const gradient = previewCtx.createRadialGradient(0, 0, 0, 0, 0, size / 2);
                    gradient.addColorStop(0, '#000000');
                    gradient.addColorStop(1, 'transparent');
                    previewCtx.beginPath();
                    previewCtx.arc(0, 0, size / 2, 0, Math.PI * 2);
                    previewCtx.fillStyle = gradient;
                    previewCtx.fill();
                    break;
                    
                case 'square':
                    previewCtx.fillStyle = '#000000';
                    previewCtx.fillRect(-size / 2, -size / 2, size, size);
                    break;
                    
                case 'texture':
                    previewCtx.fillStyle = '#000000';
                    for (let i = 0; i < 20; i++) {
                        const x = (Math.random() - 0.5) * size;
                        const y = (Math.random() - 0.5) * size;
                        previewCtx.beginPath();
                        previewCtx.arc(x, y, 1, 0, Math.PI * 2);
                        previewCtx.fill();
                    }
                    break;
                    
                default:
                    previewCtx.beginPath();
                    previewCtx.arc(0, 0, size / 2, 0, Math.PI * 2);
                    previewCtx.fillStyle = '#000000';
                    previewCtx.fill();
            }
            
            previewCtx.restore();
        }
        
        function closeBrushPicker() {
            if (window.currentBrushPicker) {
                window.currentBrushPicker.remove();
                window.currentBrushPicker = null;
            }
        }
        
        function saveBrushSettings() {
            // Update brush size and opacity controls
            document.getElementById('brushSize').value = brushSettings.size;
            document.getElementById('brushOpacity').value = brushSettings.opacity;
            document.getElementById('brushSizeValue').textContent = brushSettings.size + 'px';
            document.getElementById('brushOpacityValue').textContent = brushSettings.opacity + '%';
            
            showNotification(`ğŸ–Œï¸ Pincel ${currentBrushType} configurado!`);
            closeBrushPicker();
        }
        
        // Enhanced drawing with brush types
        function drawWithBrush(x, y) {
            const size = brushSettings.size;
            const opacity = brushSettings.opacity / 100;
            
            ctx.save();
            ctx.globalAlpha = opacity;
            ctx.fillStyle = document.getElementById('foregroundColor').style.background;
            
            switch(currentBrushType) {
                case 'round':
                case 'hard-round':
                    ctx.beginPath();
                    ctx.arc(x, y, size / 2, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'soft-round':
                    const gradient = ctx.createRadialGradient(x, y, 0, x, y, size / 2);
                    gradient.addColorStop(0, document.getElementById('foregroundColor').style.background);
                    gradient.addColorStop(1, 'transparent');
                    ctx.beginPath();
                    ctx.arc(x, y, size / 2, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    break;
                    
                case 'square':
                    ctx.fillRect(x - size / 2, y - size / 2, size, size);
                    break;
                    
                case 'texture':
                    for (let i = 0; i < 10; i++) {
                        const offsetX = (Math.random() - 0.5) * size;
                        const offsetY = (Math.random() - 0.5) * size;
                        ctx.beginPath();
                        ctx.arc(x + offsetX, y + offsetY, 1, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                    
                case 'watercolor':
                    ctx.globalAlpha = opacity * 0.3;
                    for (let i = 0; i < 5; i++) {
                        const offsetX = (Math.random() - 0.5) * size * 0.5;
                        const offsetY = (Math.random() - 0.5) * size * 0.5;
                        const radius = size / 2 + (Math.random() - 0.5) * size * 0.3;
                        ctx.beginPath();
                        ctx.arc(x + offsetX, y + offsetY, radius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                    
                default:
                    ctx.beginPath();
                    ctx.arc(x, y, size / 2, 0, Math.PI * 2);
                    ctx.fill();
            }
            
            ctx.restore();
        }

        // Background and Product Libraries
        const backgroundLibrary = [
            { name: 'Instagram', url: 'https://ik.imagekit.io/ys8l6suo53/intagram.jpg?updatedAt=' },
            { name: 'Festa Junina', url: 'https://ik.imagekit.io/ys8l6suo53/festa%20junina.jpg?updatedAt=' },
            { name: 'Black', url: 'https://ik.imagekit.io/ys8l6suo53/black.jpg?updatedAt=' },
            { name: 'Template 1234', url: 'https://ik.imagekit.io/ys8l6suo53/1234.png?updatedAt=' },
            { name: 'Black Site Banner', url: 'https://ik.imagekit.io/ys8l6suo53/black%20site%20bane%20pc.jpg?updatedAt=' },
            { name: 'Natal Computador', url: 'https://ik.imagekit.io/ys8l6suo53/natal%20computador.jpg?updatedAt=' },
            { name: 'Natal PromoÃ§Ã£o', url: 'https://ik.imagekit.io/ys8l6suo53/natal%20promo%C3%A7ao.jpg?updatedAt=' },
            { name: 'MÃªs da MÃªs', url: 'https://ik.imagekit.io/ys8l6suo53/mes%20da%20mes.jpg?updatedAt=' },
            { name: 'Sorteio', url: 'https://ik.imagekit.io/ys8l6suo53/sorteio.jpg?updatedAt=' }
        ];

        const productLibrary = [
            { name: 'Logo Principal', url: 'https://ik.imagekit.io/ys8l6suo53/logo.png?updatedAt=' },
            { name: 'Logo Alternativa', url: 'https://ik.imagekit.io/ys8l6suo53/lojo%201.png?updatedAt=' },
            { name: 'Logo Sem Fundo', url: 'https://ik.imagekit.io/ys8l6suo53/Capturar-removebg-preview.png?updatedAt=' }
        ];

        // Show backgrounds panel
        function showBackgroundsPanel() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-4/5 max-w-4xl max-h-4/5 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-lg font-bold">ğŸ–¼ï¸ Biblioteca de Fundos</h3>
                        <div class="flex gap-2">
                            <button onclick="addCustomBackground()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white text-sm">
                                â• Adicionar Fundo
                            </button>
                            <button onclick="closeBackgroundsPanel()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-white text-sm">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4" id="backgroundsGrid">
                        ${backgroundLibrary.map((bg, index) => `
                            <div class="bg-gray-700 rounded-lg p-3 hover:bg-gray-600 transition-all cursor-pointer" onclick="applyBackground('${bg.url}', '${bg.name}')">
                                <div class="aspect-video bg-gray-600 rounded mb-2 overflow-hidden">
                                    <img src="${bg.url}" alt="${bg.name}" class="w-full h-full object-cover" loading="lazy">
                                </div>
                                <p class="text-white text-sm text-center">${bg.name}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-gray-400 text-sm">Clique em um fundo para aplicar como plano de fundo da tela</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentBackgroundsPanel = dialog;
        }

        function closeBackgroundsPanel() {
            if (window.currentBackgroundsPanel) {
                window.currentBackgroundsPanel.remove();
                window.currentBackgroundsPanel = null;
            }
        }

        function addCustomBackground() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const customBg = {
                            name: file.name.split('.')[0],
                            url: e.target.result
                        };
                        backgroundLibrary.push(customBg);
                        
                        // Refresh the grid
                        const grid = document.getElementById('backgroundsGrid');
                        if (grid) {
                            grid.innerHTML += `
                                <div class="bg-gray-700 rounded-lg p-3 hover:bg-gray-600 transition-all cursor-pointer" onclick="applyBackground('${customBg.url}', '${customBg.name}')">
                                    <div class="aspect-video bg-gray-600 rounded mb-2 overflow-hidden">
                                        <img src="${customBg.url}" alt="${customBg.name}" class="w-full h-full object-cover" loading="lazy">
                                    </div>
                                    <p class="text-white text-sm text-center">${customBg.name}</p>
                                </div>
                            `;
                        }
                        
                        showNotification('ğŸ–¼ï¸ Fundo personalizado adicionado!');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function applyBackground(url, name) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                // Create temporary canvas to store background
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // Draw background image to temp canvas
                tempCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Store the background image data
                fixedBackgroundData = tempCtx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Redraw canvas with new background
                redrawCanvas();
                
                addToHistory(`Apply Background: ${name}`);
                saveState();
                showNotification(`ğŸ–¼ï¸ Fundo "${name}" aplicado como fundo fixo da tela!`);
                closeBackgroundsPanel();
            };
            img.onerror = function() {
                showNotification('âŒ Erro ao carregar o fundo!');
            };
            img.src = url;
        }

        // Show products panel
        function showProductsPanel() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-4/5 max-w-4xl max-h-4/5 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-lg font-bold">ğŸ“¦ Biblioteca de Produtos</h3>
                        <div class="flex gap-2">
                            <button onclick="addCustomProduct()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white text-sm">
                                â• Adicionar Produto
                            </button>
                            <button onclick="closeProductsPanel()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-white text-sm">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4" id="productsGrid">
                        ${productLibrary.map((product, index) => `
                            <div class="bg-gray-700 rounded-lg p-3 hover:bg-gray-600 transition-all cursor-pointer" onclick="addProduct('${product.url}', '${product.name}')">
                                <div class="aspect-square bg-gray-600 rounded mb-2 overflow-hidden flex items-center justify-center">
                                    <img src="${product.url}" alt="${product.name}" class="max-w-full max-h-full object-contain" loading="lazy">
                                </div>
                                <p class="text-white text-sm text-center">${product.name}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-gray-400 text-sm">Clique em um produto para adicionar Ã  ediÃ§Ã£o</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentProductsPanel = dialog;
        }

        function closeProductsPanel() {
            if (window.currentProductsPanel) {
                window.currentProductsPanel.remove();
                window.currentProductsPanel = null;
            }
        }

        function addCustomProduct() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(event) {
                const files = event.target.files;
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const customProduct = {
                            name: file.name.split('.')[0],
                            url: e.target.result
                        };
                        productLibrary.push(customProduct);
                        
                        // Refresh the grid
                        const grid = document.getElementById('productsGrid');
                        if (grid) {
                            grid.innerHTML += `
                                <div class="bg-gray-700 rounded-lg p-3 hover:bg-gray-600 transition-all cursor-pointer" onclick="addProduct('${customProduct.url}', '${customProduct.name}')">
                                    <div class="aspect-square bg-gray-600 rounded mb-2 overflow-hidden flex items-center justify-center">
                                        <img src="${customProduct.url}" alt="${customProduct.name}" class="max-w-full max-h-full object-contain" loading="lazy">
                                    </div>
                                    <p class="text-white text-sm text-center">${customProduct.name}</p>
                                </div>
                            `;
                        }
                    };
                    reader.readAsDataURL(file);
                }
                showNotification('ğŸ“¦ Produtos personalizados adicionados!');
            };
            input.click();
        }

        function addProduct(url, name) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                // Calculate size (max 300px while maintaining aspect ratio)
                const maxSize = 300;
                let width = img.width;
                let height = img.height;
                
                if (width > maxSize || height > maxSize) {
                    const scale = Math.min(maxSize / width, maxSize / height);
                    width *= scale;
                    height *= scale;
                }
                
                // Position in center
                const x = (canvas.width - width) / 2;
                const y = (canvas.height - height) / 2;
                
                // Create image element
                const imageElement = new Element('image', x, y, width, height);
                imageElement.data = img;
                
                elements.push(imageElement);
                
                // Select the new image element
                elements.forEach(el => el.selected = false);
                imageElement.selected = true;
                selectedElement = imageElement;
                
                redrawCanvas();
                updateLayersList();
                addToHistory(`Add Product: ${name}`);
                saveState();
                showNotification(`ğŸ“¦ Produto "${name}" adicionado!`);
                closeProductsPanel();
            };
            img.onerror = function() {
                showNotification('âŒ Erro ao carregar o produto!');
            };
            img.src = url;
        }

        // Offline detection and game
        let gameRunning = false;
        let gameScore = 0;
        let player = { x: 400, y: 350, width: 40, height: 20 };
        let bullets = [];
        let enemies = [];
        let gameKeys = {};

        window.addEventListener('online', () => {
            document.getElementById('offlineGame').classList.add('hidden');
        });

        window.addEventListener('offline', () => {
            document.getElementById('offlineGame').classList.remove('hidden');
        });

        function startGame() {
            const gameCanvas = document.getElementById('gameCanvas');
            const gameCtx = gameCanvas.getContext('2d');
            
            gameRunning = true;
            gameScore = 0;
            bullets = [];
            enemies = [];
            player = { x: 400, y: 350, width: 40, height: 20 };
            
            document.getElementById('startGameBtn').textContent = 'Jogo Rodando...';
            document.getElementById('startGameBtn').disabled = true;
            
            // Game loop
            function gameLoop() {
                if (!gameRunning) return;
                
                // Clear canvas
                gameCtx.fillStyle = '#000000';
                gameCtx.fillRect(0, 0, 800, 400);
                
                // Draw stars background
                gameCtx.fillStyle = '#ffffff';
                for (let i = 0; i < 50; i++) {
                    const x = (i * 37) % 800;
                    const y = (i * 23) % 400;
                    gameCtx.fillRect(x, y, 1, 1);
                }
                
                // Update player
                if (gameKeys['ArrowLeft'] && player.x > 0) player.x -= 5;
                if (gameKeys['ArrowRight'] && player.x < 760) player.x += 5;
                
                // Draw player (computer/spaceship)
                gameCtx.fillStyle = '#00ff00';
                gameCtx.fillRect(player.x, player.y, player.width, player.height);
                gameCtx.fillStyle = '#ffffff';
                gameCtx.fillRect(player.x + 5, player.y + 5, 10, 10);
                gameCtx.fillRect(player.x + 25, player.y + 5, 10, 10);
                
                // Update bullets
                bullets = bullets.filter(bullet => {
                    bullet.y -= 7;
                    gameCtx.fillStyle = '#ffff00';
                    gameCtx.fillRect(bullet.x, bullet.y, 3, 10);
                    return bullet.y > 0;
                });
                
                // Spawn enemies (viruses/bugs)
                if (Math.random() < 0.02) {
                    enemies.push({
                        x: Math.random() * 760,
                        y: 0,
                        width: 30,
                        height: 30,
                        type: Math.random() > 0.5 ? 'virus' : 'bug'
                    });
                }
                
                // Update enemies
                enemies = enemies.filter(enemy => {
                    enemy.y += 2;
                    
                    // Draw enemy
                    if (enemy.type === 'virus') {
                        gameCtx.fillStyle = '#ff0000';
                        gameCtx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                        gameCtx.fillStyle = '#ffffff';
                        gameCtx.fillText('ğŸ¦ ', enemy.x + 5, enemy.y + 20);
                    } else {
                        gameCtx.fillStyle = '#ff6600';
                        gameCtx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                        gameCtx.fillStyle = '#ffffff';
                        gameCtx.fillText('ğŸ›', enemy.x + 5, enemy.y + 20);
                    }
                    
                    return enemy.y < 400;
                });
                
                // Check collisions
                bullets.forEach((bullet, bulletIndex) => {
                    enemies.forEach((enemy, enemyIndex) => {
                        if (bullet.x < enemy.x + enemy.width &&
                            bullet.x + 3 > enemy.x &&
                            bullet.y < enemy.y + enemy.height &&
                            bullet.y + 10 > enemy.y) {
                            bullets.splice(bulletIndex, 1);
                            enemies.splice(enemyIndex, 1);
                            gameScore += 10;
                            document.getElementById('gameScore').textContent = gameScore;
                        }
                    });
                });
                
                // Check game over
                enemies.forEach(enemy => {
                    if (enemy.x < player.x + player.width &&
                        enemy.x + enemy.width > player.x &&
                        enemy.y < player.y + player.height &&
                        enemy.y + enemy.height > player.y) {
                        gameRunning = false;
                        document.getElementById('startGameBtn').textContent = 'Game Over - Jogar Novamente';
                        document.getElementById('startGameBtn').disabled = false;
                        alert(`Game Over! PontuaÃ§Ã£o final: ${gameScore}`);
                    }
                });
                
                requestAnimationFrame(gameLoop);
            }
            
            gameLoop();
        }

        function hideOfflineGame() {
            document.getElementById('offlineGame').classList.add('hidden');
            gameRunning = false;
        }

        // Game controls
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('offlineGame').classList.contains('hidden')) return;
            
            gameKeys[e.code] = true;
            
            if (e.code === 'Space' && gameRunning) {
                e.preventDefault();
                bullets.push({
                    x: player.x + player.width / 2,
                    y: player.y
                });
            }
        });

        document.addEventListener('keyup', (e) => {
            gameKeys[e.code] = false;
        });

        // Grouping functionality
        function groupSelectedElements() {
            if (selectedElements.length < 2) {
                showNotification('âš ï¸ Selecione pelo menos 2 elementos para agrupar!');
                return;
            }
            
            const group = {
                id: ++elementCounter,
                type: 'group',
                name: `Grupo ${Math.ceil(elementCounter / 10)}`,
                elements: [...selectedElements],
                x: Math.min(...selectedElements.map(el => el.x)),
                y: Math.min(...selectedElements.map(el => el.y)),
                width: Math.max(...selectedElements.map(el => el.x + el.width)) - Math.min(...selectedElements.map(el => el.x)),
                height: Math.max(...selectedElements.map(el => el.y + el.height)) - Math.min(...selectedElements.map(el => el.y)),
                selected: true,
                visible: true,
                opacity: 1
            };
            
            // Remove individual elements from main array
            selectedElements.forEach(el => {
                const index = elements.indexOf(el);
                if (index > -1) elements.splice(index, 1);
            });
            
            // Add group
            elements.push(group);
            
            // Update selection
            elements.forEach(el => el.selected = false);
            group.selected = true;
            selectedElement = group;
            selectedElements = [group];
            
            redrawCanvas();
            updateLayersList();
            addToHistory('Group Elements');
            showNotification(`ğŸ“ ${selectedElements.length} elementos agrupados!`);
        }
        
        // Adjustments Panel
        function showAdjustmentsPanel() {
            if (!selectedElement) {
                showNotification('âš ï¸ Selecione um elemento na camada primeiro para aplicar ajustes!');
                return;
            }
            
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 w-full max-w-2xl h-5/6 flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h3 class="text-white text-lg font-bold">ğŸ›ï¸ Painel de Ajustes - ${selectedElement.type === 'text' ? 'Texto' : selectedElement.type === 'image' ? 'Imagem' : 'Elemento'} Selecionado</h3>
                        <button onclick="closeAdjustmentsPanel()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-white text-sm">âœ•</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto pr-2" style="max-height: calc(100% - 120px);">`
                    
                        <!-- Brilho e Contraste -->
                        <div class="mb-6 border-b border-gray-600 pb-4">
                            <h4 class="text-white font-medium mb-3">â˜€ï¸ Brilho e Contraste</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white text-sm mb-1">Brilho: <span id="adjBrightnessValue">0</span></label>
                                    <input type="range" id="adjBrightness" min="-100" max="100" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">Contraste: <span id="adjContrastValue">0</span></label>
                                    <input type="range" id="adjContrast" min="-100" max="100" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                            </div>
                        </div>
                    
                        <!-- NÃ­veis -->
                        <div class="mb-6 border-b border-gray-600 pb-4">
                            <h4 class="text-white font-medium mb-3">ğŸ“Š NÃ­veis</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-white text-sm mb-1">Sombras: <span id="adjShadowsValue">0</span></label>
                                    <input type="range" id="adjShadows" min="0" max="255" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">Meio-tons: <span id="adjMidtonesValue">1.0</span></label>
                                    <input type="range" id="adjMidtones" min="0.1" max="3.0" step="0.1" value="1.0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">Realces: <span id="adjHighlightsValue">255</span></label>
                                    <input type="range" id="adjHighlights" min="0" max="255" value="255" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                            </div>
                        </div>
                    
                        <!-- Curvas -->
                        <div class="mb-6 border-b border-gray-600 pb-4">
                            <h4 class="text-white font-medium mb-3">ğŸ“ˆ Curvas</h4>
                            <div class="bg-gray-700 p-3 rounded mb-3">
                                <canvas id="curvesCanvas" width="300" height="200" class="w-full border border-gray-600 cursor-crosshair"></canvas>
                            </div>
                            <div class="flex gap-2 justify-center">
                                <button onclick="resetCurves()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-white text-xs">Reset</button>
                                <button onclick="applyCurves()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-white text-xs">Aplicar</button>
                            </div>
                        </div>
                    
                        <!-- ExposiÃ§Ã£o -->
                        <div class="mb-6 border-b border-gray-600 pb-4">
                            <h4 class="text-white font-medium mb-3">ğŸ“¸ ExposiÃ§Ã£o</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-white text-sm mb-1">ExposiÃ§Ã£o: <span id="adjExposureValue">0</span></label>
                                    <input type="range" id="adjExposure" min="-3" max="3" step="0.1" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">Offset: <span id="adjOffsetValue">0</span></label>
                                    <input type="range" id="adjOffset" min="-1" max="1" step="0.01" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">CorreÃ§Ã£o Gama: <span id="adjGammaValue">1.0</span></label>
                                    <input type="range" id="adjGamma" min="0.1" max="3.0" step="0.1" value="1.0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                            </div>
                        </div>
                    
                        <!-- VibraÃ§Ã£o e SaturaÃ§Ã£o -->
                        <div class="mb-6 border-b border-gray-600 pb-4">
                            <h4 class="text-white font-medium mb-3">ğŸŒˆ VibraÃ§Ã£o e SaturaÃ§Ã£o</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white text-sm mb-1">VibraÃ§Ã£o: <span id="adjVibranceValue">0</span></label>
                                    <input type="range" id="adjVibrance" min="-100" max="100" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">SaturaÃ§Ã£o: <span id="adjSaturationValue">0</span></label>
                                    <input type="range" id="adjSaturation" min="-100" max="100" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                            </div>
                        </div>
                    
                        <!-- Matiz -->
                        <div class="mb-6 border-b border-gray-600 pb-4">
                            <h4 class="text-white font-medium mb-3">ğŸ¨ Matiz/SaturaÃ§Ã£o</h4>
                            <div class="mb-3">
                                <label class="block text-white text-sm mb-1">Canal:</label>
                                <select id="hueChannel" class="w-full bg-gray-700 text-white px-2 py-1 text-sm rounded" onchange="applyAdjustmentPreview()">
                                    <option value="master">Mestre</option>
                                    <option value="reds">Vermelhos</option>
                                    <option value="yellows">Amarelos</option>
                                    <option value="greens">Verdes</option>
                                    <option value="cyans">Cianos</option>
                                    <option value="blues">Azuis</option>
                                    <option value="magentas">Magentas</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-white text-sm mb-1">Matiz: <span id="adjHueValue">0</span></label>
                                    <input type="range" id="adjHue" min="-180" max="180" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">SaturaÃ§Ã£o: <span id="adjHueSatValue">0</span></label>
                                    <input type="range" id="adjHueSat" min="-100" max="100" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">Luminosidade: <span id="adjLightnessValue">0</span></label>
                                    <input type="range" id="adjLightness" min="-100" max="100" value="0" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                            </div>
                        </div>
                    
                        <!-- DegradÃª de Cores -->
                        <div class="mb-6">
                            <h4 class="text-white font-medium mb-3">ğŸŒˆ Mapa de DegradÃª</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white text-sm mb-1">Preset:</label>
                                    <select id="gradientPreset" class="w-full bg-gray-700 text-white px-2 py-1 text-sm rounded" onchange="applyAdjustmentPreview()">
                                        <option value="none">Nenhum</option>
                                        <option value="warm">Tons Quentes</option>
                                        <option value="cool">Tons Frios</option>
                                        <option value="vintage">Vintage</option>
                                        <option value="dramatic">DramÃ¡tico</option>
                                        <option value="sunset">PÃ´r do Sol</option>
                                        <option value="ocean">Oceano</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">Intensidade: <span id="gradientIntensityValue">50</span>%</label>
                                    <input type="range" id="gradientIntensity" min="0" max="100" value="50" class="w-full" oninput="applyAdjustmentPreview()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 justify-end mt-4 pt-4 border-t border-gray-600 flex-shrink-0">
                        <button onclick="resetAllAdjustments()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white">Reset Tudo</button>
                        <button onclick="applyAllAdjustments()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">âœ… Aplicar ao Elemento</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            window.currentAdjustmentsPanel = dialog;
            
            // Setup adjustment controls
            setupAdjustmentControls(dialog);
            drawCurvesCanvas();
        }
        
        function setupAdjustmentControls(dialog) {
            const sliders = [
                { id: 'adjBrightness', valueId: 'adjBrightnessValue' },
                { id: 'adjContrast', valueId: 'adjContrastValue' },
                { id: 'adjShadows', valueId: 'adjShadowsValue' },
                { id: 'adjMidtones', valueId: 'adjMidtonesValue' },
                { id: 'adjHighlights', valueId: 'adjHighlightsValue' },
                { id: 'adjExposure', valueId: 'adjExposureValue' },
                { id: 'adjOffset', valueId: 'adjOffsetValue' },
                { id: 'adjGamma', valueId: 'adjGammaValue' },
                { id: 'adjVibrance', valueId: 'adjVibranceValue' },
                { id: 'adjSaturation', valueId: 'adjSaturationValue' },
                { id: 'adjHue', valueId: 'adjHueValue' },
                { id: 'adjHueSat', valueId: 'adjHueSatValue' },
                { id: 'adjLightness', valueId: 'adjLightnessValue' },
                { id: 'gradientIntensity', valueId: 'gradientIntensityValue', suffix: '%' }
            ];
            
            sliders.forEach(slider => {
                const element = dialog.querySelector(`#${slider.id}`);
                const valueElement = dialog.querySelector(`#${slider.valueId}`);
                
                element.addEventListener('input', () => {
                    valueElement.textContent = element.value + (slider.suffix || '');
                    applyAdjustmentPreview();
                });
            });
            
            // Gradient preset change
            dialog.querySelector('#gradientPreset').addEventListener('change', applyAdjustmentPreview);
        }
        
        function drawCurvesCanvas() {
            const canvas = document.getElementById('curvesCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 300, 200);
            
            // Draw grid
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const x = (i * 300) / 4;
                const y = (i * 200) / 4;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, 200);
                ctx.moveTo(0, y);
                ctx.lineTo(300, y);
                ctx.stroke();
            }
            
            // Draw diagonal line (default curve)
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, 200);
            ctx.lineTo(300, 0);
            ctx.stroke();
        }
        
        function applyAdjustmentPreview() {
            if (!selectedElement) return;
            
            // Get all adjustment values
            const adjustments = {
                brightness: parseInt(document.getElementById('adjBrightness')?.value || 0),
                contrast: parseInt(document.getElementById('adjContrast')?.value || 0),
                shadows: parseInt(document.getElementById('adjShadows')?.value || 0),
                midtones: parseFloat(document.getElementById('adjMidtones')?.value || 1.0),
                highlights: parseInt(document.getElementById('adjHighlights')?.value || 255),
                exposure: parseFloat(document.getElementById('adjExposure')?.value || 0),
                offset: parseFloat(document.getElementById('adjOffset')?.value || 0),
                gamma: parseFloat(document.getElementById('adjGamma')?.value || 1.0),
                vibrance: parseInt(document.getElementById('adjVibrance')?.value || 0),
                saturation: parseInt(document.getElementById('adjSaturation')?.value || 0),
                hue: parseInt(document.getElementById('adjHue')?.value || 0),
                hueSat: parseInt(document.getElementById('adjHueSat')?.value || 0),
                lightness: parseInt(document.getElementById('adjLightness')?.value || 0),
                gradientPreset: document.getElementById('gradientPreset')?.value || 'none',
                gradientIntensity: parseInt(document.getElementById('gradientIntensity')?.value || 50)
            };
            
            // Store adjustments in the element
            selectedElement.adjustments = adjustments;
            
            // Apply visual effects to the element
            if (selectedElement.type === 'image' || selectedElement.type === 'text') {
                // Create filter string for CSS filters
                let filterString = '';
                
                if (adjustments.brightness !== 0) {
                    filterString += `brightness(${100 + adjustments.brightness}%) `;
                }
                if (adjustments.contrast !== 0) {
                    filterString += `contrast(${100 + adjustments.contrast}%) `;
                }
                if (adjustments.saturation !== 0) {
                    filterString += `saturate(${100 + adjustments.saturation}%) `;
                }
                if (adjustments.hue !== 0) {
                    filterString += `hue-rotate(${adjustments.hue}deg) `;
                }
                
                selectedElement.filters = filterString.trim();
            }
            
            redrawCanvas();
        }
        
        function resetCurves() {
            drawCurvesCanvas();
        }
        
        function applyCurves() {
            showNotification('ğŸ“ˆ Curvas aplicadas!');
        }
        
        function resetAllAdjustments() {
            const dialog = window.currentAdjustmentsPanel;
            if (!dialog) return;
            
            // Reset all sliders to default values
            dialog.querySelector('#adjBrightness').value = 0;
            dialog.querySelector('#adjContrast').value = 0;
            dialog.querySelector('#adjShadows').value = 0;
            dialog.querySelector('#adjMidtones').value = 1.0;
            dialog.querySelector('#adjHighlights').value = 255;
            dialog.querySelector('#adjExposure').value = 0;
            dialog.querySelector('#adjOffset').value = 0;
            dialog.querySelector('#adjGamma').value = 1.0;
            dialog.querySelector('#adjVibrance').value = 0;
            dialog.querySelector('#adjSaturation').value = 0;
            dialog.querySelector('#adjHue').value = 0;
            dialog.querySelector('#adjHueSat').value = 0;
            dialog.querySelector('#adjLightness').value = 0;
            dialog.querySelector('#gradientIntensity').value = 50;
            dialog.querySelector('#gradientPreset').value = 'none';
            
            // Update displays
            setupAdjustmentControls(dialog);
            drawCurvesCanvas();
            showNotification('ğŸ”„ Todos os ajustes resetados!');
        }
        
        function applyAllAdjustments() {
            if (!selectedElement) {
                showNotification('âš ï¸ Selecione um elemento para aplicar os ajustes!');
                return;
            }
            
            // Apply adjustments to selected element
            addToHistory('Apply Adjustments');
            showNotification('âœ… Ajustes aplicados ao elemento selecionado!');
            closeAdjustmentsPanel();
        }
        
        function closeAdjustmentsPanel() {
            if (window.currentAdjustmentsPanel) {
                window.currentAdjustmentsPanel.remove();
                window.currentAdjustmentsPanel = null;
            }
        }

        // Initialize
        updateCanvasInfo();
        updateStatusBar();
        updateToolOptions(); // Show move options by default
        updateLayersList();
        saveState();
        addToHistory('New Document');
        
        // Set initial canvas background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Add welcome message
        setTimeout(() => {
            showNotification('ğŸ¨ PhotoShop Pro carregado! Tela padrÃ£o: 1000x1000px. Use os botÃµes no topo para configurar o tamanho ou adicionar texto.');
        }, 1000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9690210bf4b35cb6',t:'MTc1NDE2NDQ4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
